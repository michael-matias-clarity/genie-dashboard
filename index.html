<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>The Lamp</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #141414;
      --bg-card: rgba(255,255,255,0.03);
      --bg-card-hover: rgba(255,255,255,0.06);
      --bg-glass: rgba(30,30,30,0.8);
      
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-tertiary: rgba(255,255,255,0.4);
      
      --accent: #ffd60a;
      --accent-dim: rgba(255,214,10,0.15);
      --success: #30d158;
      --warning: #ff9f0a;
      --danger: #ff453a;
      --info: #64d2ff;
      --purple: #bf5af2;
      
      --border: rgba(255,255,255,0.08);
      --border-light: rgba(255,255,255,0.12);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      
      --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      --font-mono: 'SF Mono', 'Menlo', monospace;
    }

    html, body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: auto;
      overflow-x: hidden;
    }

    /* === HEADER === */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: calc(12px + var(--safe-top)) 20px 12px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 10px rgba(255,214,10,0.6));
    }

    .logo-text {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .logo-text span { color: var(--accent); }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      font-family: var(--font-mono);
      color: var(--text-tertiary);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-dot.syncing { background: var(--warning); box-shadow: 0 0 8px var(--warning); }

    /* === QUICK ADD === */
    .quick-add {
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .quick-add-inner {
      display: flex;
      gap: 12px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .quick-add input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 16px;
    }

    .quick-add input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .quick-add input::placeholder { color: var(--text-tertiary); }

    .quick-add button {
      padding: 14px 24px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-lg);
      color: #000;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* === TABS === */
    .mission-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 20px;
      background: var(--bg-secondary);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .mission-tabs::-webkit-scrollbar { display: none; }

    .mission-tab {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .mission-tab:hover { background: var(--bg-card); }
    .mission-tab.active { background: var(--bg-card); border-color: var(--border-light); color: var(--text-primary); }

    .mission-tab .count {
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      font-size: 0.7rem;
      font-family: var(--font-mono);
    }

    .mission-tab.active .count { background: var(--accent-dim); color: var(--accent); }

    /* === TYPE FILTER === */
    .type-filter {
      display: flex;
      gap: 8px;
      padding: 8px 20px 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .filter-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-tertiary);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .filter-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }


    /* === TASK CONTAINER === */
    .task-container {
      padding: 20px;
      padding-bottom: calc(80px + var(--safe-bottom));
      max-width: 800px;
      margin: 0 auto;
    }

    /* === TASK CARD - Description prominent === */
    .task-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .task-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    .task-card.priority-high::before { background: var(--danger); }
    .task-card.priority-medium::before { background: var(--warning); }
    .task-card.priority-low::before { background: var(--success); }

    .task-card:hover { background: var(--bg-card-hover); border-color: var(--border-light); }
    .task-card:active { transform: scale(0.995); }

    .task-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .task-title {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.4;
    }

    .task-badges {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .badge {
      padding: 3px 6px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 0.6rem;
      text-transform: uppercase;
    }

    .badge.recurring { background: var(--accent-dim); color: var(--accent); }

    /* Description - PROMINENT */
    .task-desc-preview {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      max-height: 120px;
      overflow: hidden;
      position: relative;
    }

    .task-desc-preview::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(transparent, var(--bg-tertiary));
    }

    .task-desc-preview.short::after { display: none; }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }

    .task-footer .comments-count {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--info);
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-tertiary);
    }

    .empty-state .icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-state p { font-size: 0.85rem; }

    /* === BOTTOM NAV === */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      padding-bottom: calc(12px + var(--safe-bottom));
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 20px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 0.65rem;
      cursor: pointer;
    }

    .nav-item .icon { font-size: 1.4rem; }
    .nav-item.active { color: var(--accent); }

    /* === VIEW MODAL === */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 200;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
    }

    .OLD-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 200;
      overflow-y: scroll; -webkit-overflow-scrolling: touch;
    }

    .modal.active { display: block; }

    .modal-sheet {
      background: var(--bg-secondary);
      min-height: 100vh;
      padding: 20px;
      padding-top: calc(20px + var(--safe-top));
      padding-bottom: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-close {
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .modal-edit {
      padding: 10px 16px;
      background: var(--accent-dim);
      border: none;
      border-radius: var(--radius-md);
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* View Sections */
    .view-section {
      margin-bottom: 24px;
    }

    .view-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .view-title {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.3;
    }

    /* Description - Large and prominent */
    .view-description {
      font-size: 1rem;
      color: var(--text-primary);
      line-height: 1.7;
      white-space: pre-wrap;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--accent);
    }

    /* Success Criteria */
    .view-criteria {
      padding: 16px;
      background: rgba(48, 209, 88, 0.08);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--success);
    }

    .view-criteria h4 {
      font-size: 0.8rem;
      color: var(--success);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-criteria p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* User Journey */
    .view-journey {
      padding: 16px;
      background: rgba(100, 210, 255, 0.08);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--info);
    }

    .view-journey h4 {
      font-size: 0.8rem;
      color: var(--info);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-journey p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .view-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-size: 0.8rem;
    }

    /* === COMMENTS === */
    .comments-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .comments-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 16px; }

    .comment {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 10px;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .comment-author.genie { color: var(--accent); }
    .comment-author.michael { color: var(--info); }

    .comment-time {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }

    .comment-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .comment-input-container {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    .comment-input {
      flex: 1;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 16px;
      resize: none;
      min-height: 44px;
    }

    .comment-input:focus { outline: none; border-color: var(--accent); }

    .comment-send {
      padding: 12px 20px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-md);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      align-self: flex-end;
    }

    .no-comments {
      text-align: center;
      padding: 30px;
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }

    /* === MOVE BUTTONS === */
    .move-actions {
      display: flex;
      gap: 10px;
      padding: 16px 0;
      padding-bottom: calc(16px + var(--safe-bottom));
      margin-top: 20px;
      border-top: 1px solid var(--border);
    }

    .move-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .move-btn.primary { background: var(--accent); border-color: var(--accent); color: #000; }

    /* === EDIT MODAL === */
    .edit-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 300;
      overflow-y: scroll; -webkit-overflow-scrolling: touch;
    }

    .edit-modal.active { display: block; }

    .edit-content {
      background: var(--bg-secondary);
      min-height: auto;
      padding: 24px;
      padding-top: calc(24px + var(--safe-top));
      padding-bottom: calc(100px + var(--safe-bottom));
    }

    .edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .edit-header h2 { font-size: 1.2rem; }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-group label .hint {
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      color: var(--text-tertiary);
      font-size: 0.7rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 16px;
    }

    .form-group input:focus,
    .form-group textarea:focus { outline: none; border-color: var(--accent); }

    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group textarea.large { min-height: 150px; }

    .edit-actions {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      padding-bottom: calc(16px + var(--safe-bottom));
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
    }

    .edit-actions button {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-cancel { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-delete { background: rgba(255,69,58,0.15); color: var(--danger); }
    .btn-save { background: var(--accent); color: #000; }

    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .stat-card h4 {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .stat-card .value.accent { color: var(--accent); }
    .stat-card .value.success { color: var(--success); }

    @media (min-width: 1024px) {
      .bottom-nav { display: none; }
      .task-container { padding-bottom: 40px; max-width: 900px; }
    }

    /* === ANIMATIONS === */
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px var(--accent); }
    }

    @keyframes fadeUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    .wish-sparkle {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      z-index: 1000;
      animation: fadeUp 0.8s ease-out forwards;
    }

    .grant-celebrate {
      animation: celebrate 0.6s ease-out;
    }


    /* === UNREAD BADGE === */
    .unread-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--accent);
      color: #000;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 9px;
      margin-left: 6px;
    }

  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <span class="logo-icon">ü™î</span>
        <span class="logo-text">The <span>Lamp</span></span>
      </div>
      <div class="status-bar">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">ONLINE</span>
      </div>
    </div>
  </header>

  <div class="quick-add">
    <div class="quick-add-inner">
      <input type="text" id="quick-input" placeholder="Make a wish..." enterkeyhint="send">
      <button onclick="smartAdd()">‚ú® Wish</button>
    </div>
  </div>

  <nav class="mission-tabs" id="tabs"></nav>

  <div class="type-filter" id="type-filter">
    <button class="filter-btn" data-filter="all" onclick="setTypeFilter('all')">All</button>
    <button class="filter-btn active" data-filter="single" onclick="setTypeFilter('single')">üìå One-time</button>
    <button class="filter-btn" data-filter="recurring" onclick="setTypeFilter('recurring')">üîÑ Recurring</button>
    <button class="filter-btn" data-filter="laptop" onclick="setTypeFilter('laptop')">üíª Laptop</button>
  </div>

  <main class="task-container" id="task-container"></main>

  <nav class="bottom-nav">
    <button class="nav-item active" data-view="tasks" onclick="switchView('tasks')">
      <span class="icon">ü™î</span>Wishes
    </button>
    <button class="nav-item" data-view="add" onclick="openNewTask()">
      <span class="icon">‚ú®</span>New
    </button>
    <button class="nav-item" data-view="stats" onclick="switchView('stats')">
      <span class="icon">üìä</span>Stats
    </button>
  </nav>

  <!-- VIEW MODAL -->
  <div class="modal" id="view-modal">
    <div class="modal-sheet">
      <div class="modal-header">
        <button class="modal-close" onclick="closeViewModal()">‚Üê Back</button>
        <button class="modal-edit" onclick="editCurrentTask()">Edit</button>
      </div>

      <div class="view-section">
        <div class="view-label">Wish</div>
        <div class="view-title" id="view-title"></div>
      </div>

      <div class="view-section">
        <div class="view-label">What needs to happen</div>
        <div class="view-description" id="view-desc"></div>
      </div>

      <div class="view-section" id="criteria-section" style="display:none">
        <div class="view-criteria">
          <h4>‚úÖ Success Criteria</h4>
          <p id="view-criteria"></p>
        </div>
      </div>

      <div class="view-section" id="journey-section" style="display:none">
        <div class="view-journey">
          <h4>üó∫Ô∏è User Journey</h4>
          <p id="view-journey"></p>
        </div>
      </div>

      <div class="view-section">
        <div class="view-meta" id="view-meta"></div>
      </div>

      <div class="view-section" id="celebration-image" style="display:none"></div>

      <div class="comments-section">
        <div class="comments-title">üí¨ Activity Log</div>
        <div id="comments-list"></div>
        <div class="comment-input-container">
          <textarea class="comment-input" id="comment-input" placeholder="Add feedback..." rows="1"></textarea>
          <button class="comment-send" onclick="addComment()">Send</button>
        </div>
      </div>

      <div class="move-actions" id="move-actions"></div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="edit-modal" id="edit-modal">
    <div class="edit-content">
      <div class="edit-header">
        <h2 id="edit-title">New Wish</h2>
        <button class="modal-close" onclick="closeEditModal()">Cancel</button>
      </div>
      
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="task-title" placeholder="What do you wish for?">
      </div>
      
      <div class="form-group">
        <label>Description <span class="hint">‚Äî What needs to happen</span></label>
        <textarea id="task-desc" class="large" placeholder="Describe what this wish accomplishes..."></textarea>
      </div>

      <div class="form-group">
        <label>üì∑ Image <span class="hint">‚Äî Optional attachment</span></label>
        <input type="file" id="task-image" accept="image/*" onchange="previewImage(this)" style="display:none">
        <div id="image-preview" style="margin-top:8px"></div>
        <button type="button" onclick="document.getElementById('task-image').click()" style="padding:10px 16px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer">üì∑ Add Image</button>
      </div>

      <div class="form-group">
        <label>Success Criteria <span class="hint">‚Äî How do we know it's done?</span></label>
        <textarea id="task-criteria" placeholder="‚Ä¢ Criterion 1&#10;‚Ä¢ Criterion 2&#10;‚Ä¢ Criterion 3"></textarea>
      </div>

      <div class="form-group">
        <label>User Journey <span class="hint">‚Äî Example scenario where this matters</span></label>
        <textarea id="task-journey" placeholder="When [user] wants to [action], they can now [benefit]..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Priority</label>
        <select id="task-priority">
          <option value="high">üî¥ Critical</option>
          <option value="medium">üü° Standard</option>
          <option value="low">üü¢ Low</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Type</label>
        <select id="task-type">
          <option value="single">üìå One-time</option>
          <option value="recurring">üîÑ Recurring</option>
        </select>
      </div>
      
      <div class="edit-actions">
        <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button class="btn-delete" id="delete-btn" onclick="deleteTask()">Delete</button>
        <button class="btn-save" onclick="saveTask()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const COLUMNS = {
      genie: { label: 'Genie', icon: 'üßû' },
      inbox: { label: 'Inbox', icon: 'üì•' },
      todo: { label: 'Queued', icon: 'üìã' },
      in_progress: { label: 'Granting', icon: '‚ö°' },
      review: { label: 'Review', icon: 'üëÄ' },
      done: { label: 'Granted', icon: '‚ú®' }
    };
    const COLUMN_ORDER = ['genie', 'inbox', 'todo', 'in_progress', 'review', 'done'];

    let tasks = [];
    let currentColumn = 'inbox';
    let viewingTaskId = null;
    let editingTaskId = null;
    let currentView = 'tasks';
    let typeFilter = 'single';

    function setTypeFilter(filter) {
      typeFilter = filter;
      document.querySelectorAll(".filter-btn").forEach(b => 
        b.classList.toggle("active", b.dataset.filter === filter)
      );
      renderTasks();
    }


    document.getElementById('quick-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') quickAdd();
    });

    function getUnreadGenieComments(task) {
      if (!task.comments || task.comments.length === 0) return 0;
      const seenAt = task.seenAt || 0;
      return task.comments.filter(c => c.author === "genie" && new Date(c.time).getTime() > seenAt).length;
    }
    
    // Make URLs clickable in text (XSS-safe)
    function linkify(text) {
      if (!text) return '';
      // Escape HTML first
      const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      // Then convert URLs to links
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener" style="color: var(--accent); word-break: break-all;">$1</a>');
    }


    function smartAdd() {
      const input = document.getElementById("quick-input");
      const title = input.value.trim();
      if (!title) { openNewTask(); } else { quickAdd(); }
    }

    function showWishSparkle() {
      const sparkle = document.createElement("div");
      sparkle.className = "wish-sparkle";
      sparkle.textContent = "‚ú®";
      sparkle.style.left = Math.random() * window.innerWidth + "px";
      sparkle.style.top = "150px";
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 800);
    }

    function showGrantCelebration() {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const sparkle = document.createElement("div");
          sparkle.className = "wish-sparkle";
          sparkle.textContent = ["üéâ", "‚ú®", "üåü", "üí´", "‚≠ê"][i];
          sparkle.style.left = (20 + Math.random() * 60) + "%";
          sparkle.style.top = (30 + Math.random() * 40) + "%";
          document.body.appendChild(sparkle);
          setTimeout(() => sparkle.remove(), 800);
        }, i * 100);
      }
    }


    function quickAdd() {
      const input = document.getElementById('quick-input');
      const title = input.value.trim();
      if (!title) return;

      tasks.push({
        id: Date.now().toString(),
        title,
        description: '',
        successCriteria: '',
        userJourney: '',
        column: 'inbox',
        created: new Date().toISOString().split('T')[0],
        priority: 'medium',
        type: 'single',
        comments: []
      });
      showWishSparkle();

      input.value = '';
      renderAll();
      saveTasks();
    }

    async function loadTasks() {
      updateStatus('syncing', 'SYNCING');
      try {
        const res = await fetch('/api/tasks');
        const data = await res.json();
        tasks = (data.tasks || []).map(t => ({
          ...t,
          comments: t.comments || [],
          successCriteria: t.successCriteria || '',
          userJourney: t.userJourney || ''
        }));
        renderAll();
        updateStatus('connected', 'ONLINE');
      } catch (e) {
        const saved = localStorage.getItem('lamp-tasks');
        if (saved) tasks = JSON.parse(saved);
        renderAll();
        updateStatus('offline', 'OFFLINE');
      }
    }

    async function saveTasks() {
      updateStatus('syncing', 'SAVING');
      localStorage.setItem('lamp-tasks', JSON.stringify(tasks));
      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ columns: COLUMN_ORDER, tasks })
        });
        if ((await res.json()).ok) {
          updateStatus('connected', 'SAVED');
          setTimeout(() => updateStatus('connected', 'ONLINE'), 1000);
        }
      } catch (e) {
        updateStatus('offline', 'OFFLINE');
      }
    }

    function updateStatus(state, text) {
      document.getElementById('status-dot').className = 'status-dot' + (state === 'syncing' ? ' syncing' : '');
      document.getElementById('status-text').textContent = text;
    }

    function renderTabs() {
      document.getElementById('tabs').innerHTML = COLUMN_ORDER.map(col => {
        const count = tasks.filter(t => t.column === col).length;
        return `<button class="mission-tab ${col === currentColumn ? 'active' : ''}" onclick="selectColumn('${col}')">
          ${COLUMNS[col].icon} ${COLUMNS[col].label}
          <span class="count">${count}</span>
        </button>`;
      }).join('');
    }

    function renderTasks() {
      const container = document.getElementById('task-container');
      // Genie column ignores type filter - shows all ideas
      let colTasks = tasks.filter(t => {
        if (t.column !== currentColumn) return false;
        if (currentColumn === 'genie') return true;
        if (typeFilter === 'laptop') return t.needsLaptop;
        // Hide laptop-only tasks unless laptop filter is active
        if (t.needsLaptop && typeFilter !== 'laptop') return false;
        if (typeFilter === 'all') return true;
        return (t.type || 'single') === typeFilter;
      });
      
      // Sort based on column
      if (currentColumn === 'done') {
        // Granted: newest first (by id which is timestamp, or created date)
        colTasks.sort((a, b) => {
          const aTime = parseInt(a.id) || new Date(a.created).getTime() || 0;
          const bTime = parseInt(b.id) || new Date(b.created).getTime() || 0;
          return bTime - aTime; // descending (newest first)
        });
      } else if (currentColumn === 'review') {
        // Review: oldest updates first (tasks waiting longest get attention)
        colTasks.sort((a, b) => {
          const aLast = a.comments?.length ? new Date(a.comments[a.comments.length-1].time).getTime() : (parseInt(a.id) || new Date(a.created).getTime() || 0);
          const bLast = b.comments?.length ? new Date(b.comments[b.comments.length-1].time).getTime() : (parseInt(b.id) || new Date(b.created).getTime() || 0);
          return aLast - bLast; // ascending (oldest first)
        });
      }

      // Hide type filter for genie column
      document.getElementById('type-filter').style.display = currentColumn === 'genie' ? 'none' : 'flex';

      if (colTasks.length === 0) {
        const emptyMsg = currentColumn === 'genie' 
          ? { title: 'No ideas yet', desc: 'Genie is thinking of new suggestions...' }
          : currentColumn === 'done'
          ? { title: 'All wishes granted!', desc: 'The genie awaits your command' }
          : { title: 'No wishes here', desc: 'The genie awaits your command' };
        container.innerHTML = `<div class="empty-state">
          <div class="icon">${COLUMNS[currentColumn].icon}</div>
          <h3>${emptyMsg.title}</h3>
          <p>${emptyMsg.desc}</p>
        </div>`;
        return;
      }

      container.innerHTML = colTasks.map(task => {
        const commentCount = (task.comments || []).length;
        const badges = task.type === 'recurring' ? '<span class="badge recurring">üîÑ</span>' : '';
        const desc = task.description || 'No description yet ‚Äî tap to add details';
        const isShort = desc.length < 150;
        
        return `<div class="task-card priority-${task.priority}" onclick="viewTask('${task.id}')">
          <div class="task-card-header">
            <div class="task-title">${task.title}</div>
            <div class="task-badges">${badges}</div>
          </div>
          <div class="task-desc-preview ${isShort ? 'short' : ''}">${desc}</div>
          <div class="task-footer">
            <span>${task.created}</span>
            ${task.needsLaptop ? '<span style="opacity:0.7">üíª</span>' : ''}
            ${task.image ? '<span style="opacity:0.7">üì∑</span>' : ''}
            ${(() => { const unread = getUnreadGenieComments(task); return unread > 0 ? `<span class="unread-badge">üßû ${unread}</span>` : ""; })()}${commentCount > 0 ? `<span class="comments-count">üí¨ ${commentCount}</span>` : ""}
          </div>
        </div>`;
      }).join('');
    }

    function renderAll() {
      renderTabs();
      if (currentView === 'tasks') renderTasks();
      else if (currentView === 'stats') renderStats();
    }

    function selectColumn(col) {
      currentColumn = col;
      currentView = 'tasks';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === 'tasks'));
      renderAll();
    }

    function viewTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      viewingTaskId = id;
      task.seenAt = Date.now(); saveTasks();
      document.getElementById('view-title').textContent = task.title;
      document.getElementById('view-desc').innerHTML = linkify(task.description) || 'No description provided';
      
      // Success Criteria
      const criteriaSection = document.getElementById('criteria-section');
      if (task.successCriteria) {
        document.getElementById('view-criteria').innerHTML = linkify(task.successCriteria);
        criteriaSection.style.display = 'block';
      } else {
        criteriaSection.style.display = 'none';
      }

      // User Journey
      const journeySection = document.getElementById('journey-section');
      if (task.userJourney) {
        document.getElementById('view-journey').innerHTML = linkify(task.userJourney);
        journeySection.style.display = 'block';
      } else {
        journeySection.style.display = 'none';
      }
      
      // Meta
      const pIcon = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üü¢';
      document.getElementById('view-meta').innerHTML = `
        <div class="meta-item">üìÖ ${task.created}</div>
        <div class="meta-item">${pIcon} ${task.priority}</div>
        <div class="meta-item">${task.type === 'recurring' ? 'üîÑ Recurring' : 'üìå One-time'}</div>
        <div class="meta-item">${COLUMNS[task.column].icon} ${COLUMNS[task.column].label}</div>
      `;

      // Task image or Celebration image
      const imageDiv = document.getElementById('celebration-image');
      if (task.image) {
        imageDiv.innerHTML = `<img src="${task.image}" alt="Attached" style="width:100%;border-radius:12px;margin:12px 0;">`;
        imageDiv.style.display = 'block';
      } else if (task.celebrationImage && task.column === 'done') {
        imageDiv.innerHTML = `<img src="${task.celebrationImage}" alt="Celebration" style="width:100%;border-radius:12px;margin:12px 0;">`;
        imageDiv.style.display = 'block';
      } else {
        imageDiv.style.display = 'none';
      }

      // Comments
      const comments = task.comments || [];
      if (comments.length === 0) {
        document.getElementById('comments-list').innerHTML = '<div class="no-comments">No activity yet</div>';
      } else {
        document.getElementById('comments-list').innerHTML = comments.map(c => `
          <div class="comment">
            <div class="comment-header">
              <span class="comment-author ${c.author}">${c.author === 'genie' ? 'üßû Genie' : 'üë§ Michael'}</span>
              <span class="comment-time">${c.time}</span>
            </div>
            <div class="comment-text">${linkify(c.text)}</div>
          </div>
        `).join('');
      }

      // Move buttons - special handling for genie column
      const colIdx = COLUMN_ORDER.indexOf(task.column);
      const canLeft = colIdx > 0 && task.column !== 'inbox'; // Can't go left from inbox (genie is special)
      const canRight = colIdx < COLUMN_ORDER.length - 1;
      
      if (task.column === 'genie') {
        // Genie suggestions: Approve or Discard
        document.getElementById('move-actions').innerHTML = `
          <button class="move-btn" onclick="discardIdea('${id}')">‚ùå Discard</button>
          <button class="move-btn primary" onclick="approveIdea('${id}')">‚úÖ Approve</button>
        `;
      } else if (task.column === 'review') {
        // Review tasks: option to mark for laptop review
        const laptopBtn = task.needsLaptop 
          ? `<button class="move-btn" onclick="toggleLaptop('${id}')" style="background:var(--info)">üíª On Laptop</button>`
          : `<button class="move-btn" onclick="toggleLaptop('${id}')">üíª Laptop</button>`;
        document.getElementById('move-actions').innerHTML = `
          ${canLeft ? `<button class="move-btn" onclick="moveTask('${id}', -1)">‚Üê ${COLUMNS[COLUMN_ORDER[colIdx - 1]].label}</button>` : ''}
          ${laptopBtn}
          ${canRight ? `<button class="move-btn primary" onclick="moveTask('${id}', 1)">${COLUMNS[COLUMN_ORDER[colIdx + 1]].label} ‚Üí</button>` : ''}
        `;
      } else {
        document.getElementById('move-actions').innerHTML = `
          ${canLeft ? `<button class="move-btn" onclick="moveTask('${id}', -1)">‚Üê ${COLUMNS[COLUMN_ORDER[colIdx - 1]].label}</button>` : ''}
          ${canRight ? `<button class="move-btn primary" onclick="moveTask('${id}', 1)">${COLUMNS[COLUMN_ORDER[colIdx + 1]].label} ‚Üí</button>` : ''}
        `;
      }

      document.getElementById('view-modal').classList.add('active');
    }

    function closeViewModal() {
      document.getElementById('view-modal').classList.remove('active');
      viewingTaskId = null;
    }

    function addComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text || !viewingTaskId) return;

      const task = tasks.find(t => t.id === viewingTaskId);
      if (!task) return;

      if (!task.comments) task.comments = [];
      task.comments.push({
        author: 'michael',
        text,
        time: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
      });

      input.value = '';
      viewTask(viewingTaskId);
      saveTasks();
    }

    function moveTask(id, direction) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      const idx = COLUMN_ORDER.indexOf(task.column);
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= COLUMN_ORDER.length) return;
      
      // Skip genie column when moving normally
      const targetCol = COLUMN_ORDER[newIdx];
      if (targetCol === 'genie') return;
      
      task.column = targetCol;
      
      if (targetCol === "done") {
        showGrantCelebration();
        setTimeout(closeViewModal, 600);
        // Generate celebration image
        generateCelebrationImage(task);
      }
      
      if (viewingTaskId === id) viewTask(id);
      renderAll();
      saveTasks();
    }

    async function generateCelebrationImage(task) {
      try {
        const res = await fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ taskTitle: task.title })
        });
        const data = await res.json();
        if (data.ok && data.imageUrl) {
          task.celebrationImage = data.imageUrl;
          saveTasks();
          renderAll();
        }
      } catch (e) {
        console.log('Image generation failed:', e);
      }
    }

    function approveIdea(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.column = 'inbox';
      closeViewModal();
      renderAll();
      saveTasks();
    }

    function discardIdea(id) {
      if (!confirm('Discard this idea?')) return;
      tasks = tasks.filter(t => t.id !== id);
      closeViewModal();
      renderAll();
      saveTasks();
    }

    function toggleLaptop(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.needsLaptop = !task.needsLaptop;
      viewTask(id); // Refresh the view
      renderAll();
      saveTasks();
    }

    function editCurrentTask() {
      if (!viewingTaskId) return;
      closeViewModal();
      openEditModal(viewingTaskId);
    }

    function openNewTask() {
      editingTaskId = null;
      document.getElementById('edit-title').textContent = 'New Wish';
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
      document.getElementById('task-criteria').value = '';
      document.getElementById('task-journey').value = '';
      document.getElementById('task-priority').value = 'medium';
      document.getElementById('task-type').value = 'single';
      document.getElementById('delete-btn').style.display = 'none';
      document.getElementById('edit-modal').classList.add('active');
    }

    function openEditModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;

      editingTaskId = id;
      document.getElementById('edit-title').textContent = 'Edit Wish';
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-desc').value = task.description || '';
      document.getElementById('task-criteria').value = task.successCriteria || '';
      document.getElementById('task-journey').value = task.userJourney || '';
      document.getElementById('task-priority').value = task.priority;
      document.getElementById('task-type').value = task.type || 'single';
      document.getElementById('delete-btn').style.display = 'block';
      
      // Load existing image if any
      if (task.image) {
        currentTaskImage = task.image;
        document.getElementById('image-preview').innerHTML = `<img src="${task.image}" style="max-width:100%;max-height:150px;border-radius:8px;margin-bottom:8px"><br><button type="button" onclick="clearImage()" style="padding:6px 12px;background:var(--danger);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer">Remove</button>`;
      } else {
        clearImage();
      }
      
      document.getElementById('edit-modal').classList.add('active');
    }

    let currentTaskImage = null;

    function previewImage(input) {
      const preview = document.getElementById('image-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentTaskImage = e.target.result;
          preview.innerHTML = `<img src="${currentTaskImage}" style="max-width:100%;max-height:150px;border-radius:8px;margin-bottom:8px"><br><button type="button" onclick="clearImage()" style="padding:6px 12px;background:var(--danger);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer">Remove</button>`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function clearImage() {
      currentTaskImage = null;
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('task-image').value = '';
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      editingTaskId = null;
      clearImage();
    }

    function saveTask() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) return;

      const data = {
        title,
        description: document.getElementById('task-desc').value.trim(),
        successCriteria: document.getElementById('task-criteria').value.trim(),
        userJourney: document.getElementById('task-journey').value.trim(),
        priority: document.getElementById('task-priority').value,
        type: document.getElementById('task-type').value,
        image: currentTaskImage || undefined
      };

      if (editingTaskId) {
        const task = tasks.find(t => t.id === editingTaskId);
        if (task) Object.assign(task, data);
      } else {
        tasks.push({
          id: Date.now().toString(),
          ...data,
          column: 'inbox',
          created: new Date().toISOString().split('T')[0],
          comments: []
        });
      showWishSparkle();
      }

      closeEditModal();
      renderAll();
      saveTasks();
    }

    function deleteTask() {
      if (!editingTaskId || !confirm('Delete this wish?')) return;
      tasks = tasks.filter(t => t.id !== editingTaskId);
      closeEditModal();
      renderAll();
      saveTasks();
    }

    function switchView(view) {
      currentView = view;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === view));
      if (view === 'stats') renderStats();
      else renderTasks();
    }

    function renderStats() {
      const counts = COLUMN_ORDER.reduce((acc, col) => {
        acc[col] = tasks.filter(t => t.column === col).length;
        return acc;
      }, {});

      document.getElementById('task-container').innerHTML = `<div class="stats-grid">
        <div class="stat-card"><h4>Granting</h4><div class="value accent">${counts.in_progress}</div></div>
        <div class="stat-card"><h4>Review</h4><div class="value">${counts.review}</div></div>
        <div class="stat-card"><h4>Granted</h4><div class="value success">${counts.done}</div></div>
        <div class="stat-card"><h4>Total</h4><div class="value">${tasks.length}</div></div>
      </div>`;
    }

    document.getElementById('comment-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addComment(); }
    });
    
    // Scroll comment input into view when focused (for mobile keyboard)
    document.getElementById('comment-input').addEventListener('focus', () => {
      setTimeout(() => document.getElementById('comment-input').scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
    });

    loadTasks();
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
