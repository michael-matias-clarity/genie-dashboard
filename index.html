<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genie Task Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    header h1 span { color: #00d9ff; }
    header p { color: #888; font-size: 0.9rem; }
    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .column {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      min-height: 500px;
    }
    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .column-title {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
    }
    .column-count {
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    .column[data-column="inbox"] .column-title { color: #ffd93d; }
    .column[data-column="todo"] .column-title { color: #6bcb77; }
    .column[data-column="in_progress"] .column-title { color: #00d9ff; }
    .column[data-column="done"] .column-title { color: #888; }
    .task {
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 3px solid transparent;
    }
    .task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .task.dragging { opacity: 0.5; cursor: grabbing; }
    .task.priority-high { border-left-color: #ff6b6b; }
    .task.priority-medium { border-left-color: #ffd93d; }
    .task.priority-low { border-left-color: #6bcb77; }
    .task.type-recurring { 
      background: rgba(0,217,255,0.08);
      border-right: 3px solid #00d9ff;
    }
    .task.type-single { background: rgba(255,255,255,0.08); }
    .task-type {
      display: inline-block;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .task-type.recurring { background: rgba(0,217,255,0.3); color: #00d9ff; }
    .task-type.single { background: rgba(255,255,255,0.15); color: #888; }
    .task-title {
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    .task-desc {
      font-size: 0.8rem;
      color: #aaa;
      line-height: 1.4;
    }
    .task-meta {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #666;
    }
    .add-task {
      width: 100%;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }
    .add-task:hover {
      border-color: #00d9ff;
      color: #00d9ff;
    }
    .column.drag-over {
      background: rgba(0,217,255,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1a1a2e;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }
    .modal h2 { margin-bottom: 20px; }
    .modal input, .modal textarea, .modal select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
    }
    .modal textarea { min-height: 80px; resize: vertical; }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-primary { background: #00d9ff; color: #000; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .sync-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      font-size: 0.8rem;
    }
    @media (max-width: 900px) {
      .board { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .board { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üßû <span>Genie</span> Task Dashboard</h1>
    <p>Drag tasks between columns ‚Ä¢ Click + to add new tasks</p>
  </header>

  <div class="board" id="board"></div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>New Task</h2>
      <input type="text" id="task-title" placeholder="Task title">
      <textarea id="task-desc" placeholder="Description (what should Genie do?)"></textarea>
      <select id="task-priority">
        <option value="high">üî¥ High Priority</option>
        <option value="medium" selected>üü° Medium Priority</option>
        <option value="low">üü¢ Low Priority</option>
      </select>
      <select id="task-type">
        <option value="single" selected>üìå Single Task (one-time)</option>
        <option value="recurring">üîÑ Recurring (ongoing)</option>
      </select>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="addTask()">Add Task</button>
      </div>
    </div>
  </div>

  <div class="sync-status" id="sync-status">‚úì Synced</div>

  <script>
    const COLUMNS = {
      inbox: 'üì• Inbox',
      todo: 'üìã To Do',
      in_progress: '‚ö° In Progress',
      done: '‚úÖ Done'
    };

    let tasks = [];
    let draggedTask = null;

    async function loadTasks() {
      try {
        const res = await fetch('/api/tasks');
        const data = await res.json();
        tasks = data.tasks || [];
        renderBoard();
        updateSyncStatus('‚úì Synced');
      } catch (e) {
        console.error('Failed to load tasks:', e);
        // Fallback to localStorage
        const saved = localStorage.getItem('genie-tasks');
        if (saved) tasks = JSON.parse(saved);
        renderBoard();
        updateSyncStatus('‚ö† Offline mode');
      }
    }

    function renderBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';

      Object.entries(COLUMNS).forEach(([key, label]) => {
        const colTasks = tasks.filter(t => t.column === key);
        const col = document.createElement('div');
        col.className = 'column';
        col.dataset.column = key;
        col.innerHTML = `
          <div class="column-header">
            <span class="column-title">${label}</span>
            <span class="column-count">${colTasks.length}</span>
          </div>
          <div class="tasks"></div>
          ${key === 'inbox' ? '<button class="add-task" onclick="openModal()">+ Add Task</button>' : ''}
        `;

        const tasksContainer = col.querySelector('.tasks');
        colTasks.forEach(task => {
          const taskEl = document.createElement('div');
          const taskType = task.type || 'single';
          taskEl.className = `task priority-${task.priority} type-${taskType}`;
          taskEl.draggable = true;
          taskEl.dataset.id = task.id;
          const typeLabel = taskType === 'recurring' ? 'üîÑ recurring' : 'üìå single';
          const typeBadge = `<span class="task-type ${taskType}">${typeLabel}</span>`;
          taskEl.innerHTML = `
            <div class="task-title">${task.title}${typeBadge}</div>
            <div class="task-desc">${task.description}</div>
            <div class="task-meta">
              <span>${task.created}</span>
              <span>${task.priority}</span>
            </div>
          `;
          taskEl.addEventListener('dragstart', handleDragStart);
          taskEl.addEventListener('dragend', handleDragEnd);
          tasksContainer.appendChild(taskEl);
        });

        col.addEventListener('dragover', handleDragOver);
        col.addEventListener('drop', handleDrop);
        col.addEventListener('dragleave', handleDragLeave);

        board.appendChild(col);
      });
    }

    function handleDragStart(e) {
      draggedTask = e.target;
      e.target.classList.add('dragging');
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      const column = e.currentTarget.dataset.column;
      const taskId = draggedTask.dataset.id;
      
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.column = column;
        renderBoard();
        saveTasks();
      }
    }

    function openModal() {
      document.getElementById('modal').classList.add('active');
      document.getElementById('task-title').focus();
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
    }

    function addTask() {
      const title = document.getElementById('task-title').value.trim();
      const desc = document.getElementById('task-desc').value.trim();
      const priority = document.getElementById('task-priority').value;
      const type = document.getElementById('task-type').value;

      if (!title) return;

      const task = {
        id: Date.now().toString(),
        title,
        description: desc || 'No description',
        column: 'inbox',
        created: new Date().toISOString().split('T')[0],
        priority,
        type
      };

      tasks.push(task);
      renderBoard();
      saveTasks();
      closeModal();
    }

    async function saveTasks() {
      updateSyncStatus('‚è≥ Saving...');
      localStorage.setItem('genie-tasks', JSON.stringify(tasks));
      
      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ columns: Object.keys(COLUMNS), tasks })
        });
        const data = await res.json();
        if (data.ok) {
          updateSyncStatus('‚úì Synced');
        } else {
          updateSyncStatus('‚ö† Sync failed');
        }
      } catch (e) {
        console.error('Failed to save:', e);
        updateSyncStatus('‚ö† Offline - saved locally');
      }
    }

    function updateSyncStatus(text) {
      document.getElementById('sync-status').textContent = text;
    }

    // Load tasks from server (falls back to localStorage if offline)
    loadTasks();

    // Poll for updates every 30 seconds (in case I update tasks)
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
