<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>The Lamp</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™î</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™î</text></svg>">
  <link rel="manifest" href="/manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #141414;
      --bg-card: rgba(255,255,255,0.03);
      --bg-card-hover: rgba(255,255,255,0.06);
      --bg-glass: rgba(30,30,30,0.8);
      
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-tertiary: rgba(255,255,255,0.4);
      
      --accent: #ffd60a;
      --accent-dim: rgba(255,214,10,0.15);
      --success: #30d158;
      --warning: #ff9f0a;
      --danger: #ff453a;
      --info: #64d2ff;
      --purple: #bf5af2;
      
      --border: rgba(255,255,255,0.08);
      --border-light: rgba(255,255,255,0.12);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      
      --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      --font-mono: 'SF Mono', 'Menlo', monospace;
    }

    html, body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* === HEADER === */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: calc(12px + var(--safe-top)) 20px 12px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 10px rgba(255,214,10,0.6));
    }

    .logo-text {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .logo-text span { color: var(--accent); }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      font-family: var(--font-mono);
      color: var(--text-tertiary);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-dot.syncing { background: var(--warning); box-shadow: 0 0 8px var(--warning); }

    /* === QUICK ADD === */
    .quick-add {
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .quick-add-inner {
      display: flex;
      gap: 12px;
      max-width: 1400px;
      margin: 0 auto;
    }

    #voice-btn {
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    #voice-btn:hover { background: var(--bg-secondary); }

    .quick-add input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 16px;
    }

    .quick-add input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .quick-add input::placeholder { color: var(--text-tertiary); }

    .quick-add button {
      padding: 14px 24px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-lg);
      color: #000;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* === TABS === */
    .mission-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 20px;
      background: var(--bg-secondary);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .mission-tabs::-webkit-scrollbar { display: none; }

    .mission-tab {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .mission-tab:hover { background: var(--bg-card); }
    .mission-tab.active { background: var(--bg-card); border-color: var(--border-light); color: var(--text-primary); }

    .mission-tab .count {
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      font-size: 0.7rem;
      font-family: var(--font-mono);
    }

    .mission-tab.active .count { background: var(--accent-dim); color: var(--accent); }

    /* === TYPE FILTER === */
    .type-filter {
      display: flex;
      gap: 8px;
      padding: 8px 20px 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .filter-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-tertiary);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .filter-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }


    /* === TASK CONTAINER === */
    .task-container {
      padding: 20px;
      padding-bottom: calc(80px + var(--safe-bottom));
      max-width: 800px;
      margin: 0 auto;
      flex: 1;
    }

    /* === TASK CARD - Description prominent === */
    .task-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .task-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    .task-card.priority-high::before { background: var(--danger); }
    .task-card.priority-medium::before { background: var(--warning); }
    .task-card.priority-low::before { background: var(--success); }

    .task-card:hover { background: var(--bg-card-hover); border-color: var(--border-light); }
    .task-card:active { transform: scale(0.995); }

    .task-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .task-title {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.4;
    }

    .task-badges {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .badge {
      padding: 3px 6px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 0.6rem;
      text-transform: uppercase;
    }

    .badge.recurring { background: var(--accent-dim); color: var(--accent); }

    /* Description - PROMINENT */
    .task-desc-preview {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      max-height: 120px;
      overflow: hidden;
      position: relative;
    }

    .task-desc-preview::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(transparent, var(--bg-tertiary));
    }

    .task-desc-preview.short::after { display: none; }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }

    .task-footer .comments-count {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--info);
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-tertiary);
    }

    .empty-state .icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-state p { font-size: 0.85rem; }

    /* === DESKTOP CONTROLS (hidden on mobile) === */
    .desktop-controls {
      display: none;
    }

    /* === BOTTOM NAV === */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      padding-bottom: calc(12px + var(--safe-bottom));
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 20px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 0.65rem;
      cursor: pointer;
    }

    .nav-item .icon { font-size: 1.4rem; }
    .nav-item.active { color: var(--accent); }

    /* === VIEW MODAL === */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 200;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
    }

    .OLD-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 200;
      overflow-y: scroll; -webkit-overflow-scrolling: touch;
    }

    .modal.active { display: block; }

    .modal-sheet {
      background: var(--bg-secondary);
      min-height: 100vh;
      padding: 20px;
      padding-top: calc(20px + var(--safe-top));
      padding-bottom: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-close {
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .modal-edit {
      padding: 10px 16px;
      background: var(--accent-dim);
      border: none;
      border-radius: var(--radius-md);
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* View Sections */
    .view-section {
      margin-bottom: 24px;
    }

    .view-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .view-title {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.3;
    }

    /* Description - Large and prominent */
    .view-description {
      font-size: 1rem;
      color: var(--text-primary);
      line-height: 1.7;
      white-space: pre-wrap;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--accent);
    }

    /* Success Criteria */
    .view-criteria {
      padding: 16px;
      background: rgba(48, 209, 88, 0.08);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--success);
    }

    .view-criteria h4 {
      font-size: 0.8rem;
      color: var(--success);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-criteria p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* User Journey */
    .view-journey {
      padding: 16px;
      background: rgba(100, 210, 255, 0.08);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--info);
    }

    .view-journey h4 {
      font-size: 0.8rem;
      color: var(--info);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-journey p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .view-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-size: 0.8rem;
    }

    /* === RECURRING PANEL === */
    .recurring-panel {
      display: none;
      width: 220px;
      flex-shrink: 0;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      padding: 16px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      position: fixed;
      right: 0;
      top: 60px;
    }
    body.kanban-mode .recurring-panel { display: block; }
    .recurring-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .recurring-task {
      padding: 12px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .recurring-task:hover { background: rgba(255,255,255,0.05); }
    .recurring-task-title { color: var(--text-primary); margin-bottom: 4px; }
    .recurring-task-status { font-size: 0.75rem; color: var(--text-tertiary); }
    @media (max-width: 768px) {
      .recurring-panel { display: none !important; }
    }

    /* === SUBTASKS === */
    .subtasks-section {
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    .subtasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .subtasks-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
    .subtasks-progress { font-size: 0.8rem; color: var(--accent); }
    .subtask-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .subtask-item:last-child { border-bottom: none; }
    .subtask-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
    .subtask-text { flex: 1; font-size: 0.9rem; color: var(--text-primary); }
    .subtask-text.completed { text-decoration: line-through; color: var(--text-secondary); }
    .subtask-delete { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; opacity: 0.5; }
    .subtask-delete:hover { opacity: 1; color: var(--danger); }
    .add-subtask-form { display: flex; gap: 8px; margin-top: 12px; }
    .add-subtask-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    .add-subtask-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
    }

    /* === COMMENTS === */
    .comments-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .comments-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 16px; }

    .comment {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 10px;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .comment-author.genie { color: var(--accent); }
    .comment-author.michael { color: var(--info); }

    .comment-time {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }

    .comment-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .comment-input-container {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    .comment-input {
      flex: 1;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 16px;
      resize: none;
      min-height: 44px;
    }

    .comment-input:focus { outline: none; border-color: var(--accent); }

    .comment-send {
      padding: 12px 20px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-md);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      align-self: flex-end;
    }

    .no-comments {
      text-align: center;
      padding: 30px;
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }

    /* === MOVE BUTTONS === */
    .move-actions {
      display: flex;
      gap: 10px;
      padding: 16px 0;
      padding-bottom: calc(16px + var(--safe-bottom));
      margin-top: 20px;
      border-top: 1px solid var(--border);
      border-top: 1px solid var(--border);
      z-index: 210;
    }

    .move-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }

    .move-btn.primary { background: var(--accent); border-color: var(--accent); color: #000; }

    /* === EDIT MODAL === */
    .edit-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 300;
      overflow-y: scroll; -webkit-overflow-scrolling: touch;
    }

    .edit-modal.active { display: block; }

    .edit-content {
      background: var(--bg-secondary);
      min-height: auto;
      padding: 24px;
      padding-top: calc(24px + var(--safe-top));
      padding-bottom: calc(100px + var(--safe-bottom));
    }

    .edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .edit-header h2 { font-size: 1.2rem; }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-group label .hint {
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      color: var(--text-tertiary);
      font-size: 0.7rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 16px;
    }

    .form-group input:focus,
    .form-group textarea:focus { outline: none; border-color: var(--accent); }

    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group textarea.large { min-height: 150px; }

    .edit-actions {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      padding-bottom: calc(16px + var(--safe-bottom));
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
    }

    .edit-actions button {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-cancel { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-delete { background: rgba(255,69,58,0.15); color: var(--danger); }
    .btn-save { background: var(--accent); color: #000; }

    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .stat-card h4 {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .stat-card .value.accent { color: var(--accent); }
    .stat-card .value.success { color: var(--success); }
    
    /* === KANBAN - Hide on mobile, show on desktop === */
    .kanban-container {
      display: none;
    }

    @media (min-width: 1024px) {
      /* Desktop: No page scroll - components scroll internally */
      html, body {
        height: 100vh;
        overflow: hidden;
      }
      
      /* Desktop: Better layout */
      .bottom-nav { 
        position: static;
        background: transparent;
        border: none;
        justify-content: center;
        gap: 8px;
        padding: 16px 0;
        backdrop-filter: none;
        margin-top: auto;
      }
      .bottom-nav .nav-item {
        flex-direction: row;
        gap: 6px;
        padding: 10px 20px;
        background: var(--bg-secondary);
        border-radius: var(--radius);
        font-size: 0.85rem;
      }
      .bottom-nav .nav-item .icon { font-size: 1rem; }
      .bottom-nav .nav-item.active { background: var(--accent); color: black; }
      
      .task-container { 
        padding-bottom: 40px; 
        max-width: 1200px;
        flex: 1;
        min-height: 0;
      }
      
      /* Wider cards on desktop */
      .task-card {
        padding: 20px 24px;
      }
      .task-title { font-size: 1.1rem; }
      .task-description { font-size: 0.95rem; }
      
      /* Desktop column tabs as pills */
      .mission-tabs {
        gap: 8px;
        margin: 0 auto 20px;
        max-width: 1200px;
      }
      .tab {
        padding: 10px 24px;
        font-size: 0.9rem;
      }
      
      /* Quick add wider */
      .quick-add-inner {
        max-width: 800px;
      }
      
      /* Header more prominent */
      header h1 { font-size: 2rem; }
      
      /* Better modal on desktop */
      .modal-sheet {
        max-width: 700px;
        margin: 60px auto;
        border-radius: var(--radius-lg);
        max-height: calc(100vh - 120px);
      }
      
      /* === ENHANCED DESKTOP EXPERIENCE === */
      
      /* Task list with better spacing */
      .task-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 16px;
        padding: 0;
      }
      
      /* Task cards with enhanced hover */
      .task-card {
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        border-color: var(--border-light);
      }
      
      /* Quick add more prominent on desktop */
      .quick-add {
        padding: 24px 40px;
      }
      .quick-add-inner {
        max-width: 900px;
        gap: 16px;
      }
      .quick-add input {
        font-size: 18px;
        padding: 18px 24px;
      }
      .quick-add button {
        padding: 18px 32px;
        font-size: 1rem;
      }
      
      /* Edit modal - responsive, centered, polished */
      .edit-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(8px);
      }
      .edit-modal .edit-content {
        width: min(520px, 92vw);
        max-width: 520px;
        margin: 0;
        background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        border-radius: var(--radius-xl);
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 0 1px var(--border);
        padding: 0;
        overflow: hidden;
        animation: modalSlideIn 0.2s ease-out;
      }
      @keyframes modalSlideIn {
        from { opacity: 0; transform: scale(0.95) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
      }
      .edit-modal .edit-header {
        padding: 24px 28px 20px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        background: var(--bg-tertiary);
      }
      .edit-modal .edit-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .edit-modal .edit-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px 28px;
      }
      .edit-modal .modal-close {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .edit-modal .modal-close:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-light);
      }
      .edit-modal .form-group {
        margin-bottom: 20px;
      }
      .edit-modal .form-group label {
        font-size: 0.8rem;
        margin-bottom: 10px;
      }
      .edit-modal .form-group input,
      .edit-modal .form-group textarea,
      .edit-modal .form-group select {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        transition: all 0.15s ease;
      }
      .edit-modal .form-group input:focus,
      .edit-modal .form-group textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-dim);
      }
      .edit-modal .edit-actions {
        padding: 20px 28px 24px;
        border-top: 1px solid var(--border);
        flex-shrink: 0;
        background: var(--bg-tertiary);
        position: static;
        gap: 12px;
      }
      .edit-modal .btn-save {
        flex: 2;
        font-weight: 600;
        transition: all 0.15s ease;
      }
      .edit-modal .btn-save:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
      }
      .edit-modal .btn-cancel,
      .edit-modal .btn-delete {
        flex: 1;
      }
      .edit-modal input,
      .edit-modal textarea {
        font-size: 15px;
      }
      .edit-modal textarea {
        min-height: 90px;
      }
      
      /* View modal with larger text */
      .modal-sheet .view-title { font-size: 1.5rem; }
      .modal-sheet .view-description { font-size: 1.05rem; line-height: 1.7; }
      .comment-input { font-size: 16px; }
      
      /* Tabs more visible */
      .mission-tabs {
        padding: 16px 40px;
        gap: 12px;
      }
      .mission-tab {
        padding: 12px 24px;
        font-size: 0.95rem;
      }
      
      /* Filter row better positioned */
      .filter-row {
        padding: 0 40px 16px;
        max-width: 1400px;
        margin: 0 auto;
      }
      
      /* Stats row improvement */
      .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        padding: 24px 40px;
        max-width: 1400px;
        margin: 0 auto;
      }
      
      /* Task container centering */
      
      /* === KANBAN BOARD LAYOUT === */
      .kanban-container {
        display: flex;
        flex: 1;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 20px 24px;
        gap: 16px;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
        min-height: 0;
        align-items: stretch;
      }
      
      .kanban-container::-webkit-scrollbar {
        height: 8px;
      }
      .kanban-container::-webkit-scrollbar-track {
        background: transparent;
      }
      .kanban-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }
      .kanban-container::-webkit-scrollbar-thumb:hover {
        background: var(--border-light);
      }
      
      .kanban-column {
        flex: 0 0 340px;
        min-width: 340px;
        height: 100%;
        max-height: none;
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
        scroll-snap-align: start;
      }
      
      .kanban-column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 18px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 1;
      }
      
      .kanban-column-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        font-weight: 600;
      }
      
      .kanban-column-title .icon {
        font-size: 1.1rem;
      }
      
      .kanban-column-count {
        padding: 4px 10px;
        background: var(--bg-card);
        border-radius: 12px;
        font-size: 0.75rem;
        font-family: var(--font-mono);
        color: var(--text-secondary);
      }
      
      .kanban-column-tasks {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .kanban-column-tasks::-webkit-scrollbar {
        width: 6px;
      }
      .kanban-column-tasks::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      
      /* Kanban cards - more compact */
      .kanban-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      .kanban-card::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 3px;
        border-radius: var(--radius-md) 0 0 var(--radius-md);
      }
      
      .kanban-card.priority-high::before { background: var(--danger); }
      .kanban-card.priority-medium::before { background: var(--warning); }
      .kanban-card.priority-low::before { background: var(--success); }
      
      .kanban-card:hover {
        transform: translateY(-2px);
        background: var(--bg-card-hover);
        border-color: var(--border-light);
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      }
      
      .kanban-card-title {
        font-size: 0.9rem;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 8px;
        color: var(--text-primary);
      }
      
      .kanban-card-desc {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.4;
        max-height: 60px;
        overflow: hidden;
        margin-bottom: 10px;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
      }
      
      .kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        color: var(--text-tertiary);
      }
      
      .kanban-card-meta {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* Empty column state */
      .kanban-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-tertiary);
      }
      .kanban-empty .icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.4; }
      .kanban-empty p { font-size: 0.8rem; }
      
      /* Drag and drop styles */
      .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
      }
      
      .kanban-column.drag-over {
        background: var(--accent-dim);
        border-color: var(--accent);
      }
      
      .kanban-column-tasks.drag-over {
        background: rgba(255,214,10,0.05);
        min-height: 100px;
      }
      
      /* Hide tabs on desktop when Kanban is active */
      body.kanban-mode .mission-tabs { display: none; }
      body.kanban-mode .type-filter { display: none; }
      body.kanban-mode .task-container { display: none; }
      body.kanban-mode .kanban-container { display: flex; }
      
      /* Show Kanban on desktop by default */
      .kanban-container { display: flex; }
      .task-container { display: none; }
      .mission-tabs { display: none; }
      .type-filter { display: none; }
      
      /* Desktop Control Bar - always visible at top */
      .desktop-controls {
        display: block;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        padding: 12px 24px;
        position: sticky;
        top: 60px;
        z-index: 90;
      }
      
      .desktop-controls-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1800px;
        margin: 0 auto;
        gap: 24px;
      }
      
      .desktop-nav {
        display: flex;
        gap: 4px;
      }
      
      .desktop-nav-btn {
        padding: 10px 18px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .desktop-nav-btn:hover {
        background: var(--bg-card-hover);
        border-color: var(--border-light);
      }
      
      .desktop-nav-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #000;
        font-weight: 600;
      }
      
      .desktop-filters {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .filter-label {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-right: 4px;
      }
      
      .desktop-filter-btn {
        padding: 8px 14px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 20px;
        color: var(--text-tertiary);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .desktop-filter-btn:hover {
        background: var(--bg-card);
        color: var(--text-secondary);
      }
      
      .desktop-filter-btn.active {
        background: var(--accent-dim);
        border-color: var(--accent);
        color: var(--accent);
      }
      
      .desktop-actions {
        display: flex;
        gap: 8px;
      }
      
      .desktop-action-btn {
        padding: 10px 20px;
        background: var(--accent);
        border: none;
        border-radius: var(--radius-md);
        color: #000;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .desktop-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 214, 10, 0.3);
      }
      
      .desktop-action-btn.secondary {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
      }
      
      .desktop-action-btn.secondary:hover {
        background: var(--bg-card-hover);
        box-shadow: none;
      }
      
      /* Hide bottom nav on desktop */
      .bottom-nav { display: none; }
      .task-container {
        padding: 20px 40px 60px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }
    }
    
    /* Extra wide screens */
    @media (min-width: 1440px) {
      .task-list {
        grid-template-columns: repeat(3, 1fr);
      }
      .modal-sheet {
        max-width: 800px;
      }
    }

    /* === ANIMATIONS === */
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px var(--accent); }
    }

    @keyframes fadeUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    .wish-sparkle {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      z-index: 1000;
      animation: fadeUp 0.8s ease-out forwards;
    }

    .grant-celebrate {
      animation: celebrate 0.6s ease-out;
    }


    /* === UNREAD BADGE === */
    .unread-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      background: var(--accent);
      color: #000;
      font-size: 0.75rem;
      font-weight: 700;
      border-radius: 11px;
      margin-left: 6px;
      animation: pulse-badge 2s ease-in-out infinite;
      box-shadow: 0 0 8px var(--accent);
    }
    
    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.9; }
    }
    
    /* Card glow when has unread comments */
    .task-card.has-unread,
    .kanban-card.has-unread {
      border-color: var(--accent) !important;
      box-shadow: 0 0 12px rgba(255, 214, 10, 0.3);
    }

  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <span class="logo-icon">ü™î</span>
        <span class="logo-text">The <span>Lamp</span></span>
      </div>
      <div class="status-bar">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">ONLINE</span>
      </div>
    </div>
  </header>

  <div class="quick-add">
    <div class="quick-add-inner">
      <input type="text" id="quick-input" placeholder="Make a wish..." enterkeyhint="send">
      <button id="voice-btn" onclick="toggleVoiceRecording()" title="Voice wish">üé§</button>
      <button onclick="smartAdd()">‚ú® Wish</button>
    </div>
  </div>

  <nav class="mission-tabs" id="tabs"></nav>

  <div class="type-filter" id="type-filter">
    <button class="filter-btn" data-filter="all" onclick="setTypeFilter('all')">All</button>
    <button class="filter-btn active" data-filter="single" onclick="setTypeFilter('single')">üìå One-time</button>
    <button class="filter-btn" data-filter="laptop" onclick="setTypeFilter('laptop')">üíª Laptop</button>
    <button class="filter-btn" data-filter="mobile" onclick="setTypeFilter('mobile')">üì± Mobile</button>
  </div>

  <!-- Desktop Control Bar (replaces bottom nav on desktop) -->
  <div class="desktop-controls" id="desktop-controls">
    <div class="desktop-controls-inner">
      <div class="desktop-nav">
        <button class="desktop-nav-btn active" data-view="tasks" onclick="switchView('tasks')">ü™î Wishes</button>
        <button class="desktop-nav-btn" data-view="recurring" onclick="switchView('recurring')">üîÑ Recurring</button>
        <button class="desktop-nav-btn" data-view="history" onclick="switchView('history')">üìú History</button>
        <button class="desktop-nav-btn" data-view="console" onclick="switchView('console')">üñ•Ô∏è Console</button>
        <button class="desktop-nav-btn" data-view="stats" onclick="switchView('stats')">üìä Stats</button>
      </div>
      <div class="desktop-filters" id="desktop-type-filter">
        <span class="filter-label">Filter:</span>
        <button class="desktop-filter-btn" data-filter="all" onclick="setTypeFilter('all')">All</button>
        <button class="desktop-filter-btn active" data-filter="single" onclick="setTypeFilter('single')">üìå One-time</button>
        <button class="desktop-filter-btn" data-filter="laptop" onclick="setTypeFilter('laptop')">üíª Laptop</button>
        <button class="desktop-filter-btn" data-filter="mobile" onclick="setTypeFilter('mobile')">üì± Mobile</button>
      </div>
      <div class="desktop-actions">
        <button class="desktop-action-btn" onclick="openNewTask()">‚ú® New Wish</button>
        <button class="desktop-action-btn secondary" onclick="openLampFeedback()">üêõ Lamp Feedback</button>
      </div>
    </div>
  </div>

  <main class="task-container" id="task-container"></main>
  
  <!-- Kanban Board (Desktop only) -->
  <div class="kanban-container" id="kanban-container"></div>
  
  <!-- Recurring Tasks Panel (Desktop only) -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-view="tasks" onclick="switchView('tasks')">
      <span class="icon">ü™î</span>Wishes
    </button>
    <button class="nav-item" data-view="add" onclick="openNewTask()">
      <span class="icon">‚ú®</span>New
    </button>
    <button class="nav-item" data-view="console" onclick="switchView('console')">
      <span class="icon">üñ•Ô∏è</span>Console
    </button>
    <button class="nav-item" data-view="history" onclick="switchView('history')">
      <span class="icon">üìú</span>History
    </button>
    <button class="nav-item" data-view="stats" onclick="switchView('stats')">
      <span class="icon">üìä</span>Stats
    </button>
  </nav>

  <!-- VIEW MODAL -->
  <div class="modal" id="view-modal">
    <div class="modal-sheet">
      <div class="modal-header">
        <button class="modal-close" onclick="closeViewModal()">‚Üê Back</button>
        <button class="modal-edit" onclick="editCurrentTask()">Edit</button>
      </div>

      <div class="view-section">
        <div class="view-label">Wish</div>
        <div class="view-title" id="view-title"></div>
      </div>

      <div class="view-section">
        <div class="view-label">What needs to happen</div>
        <div class="view-description" id="view-desc"></div>
      </div>

      <div class="view-section" id="criteria-section" style="display:none">
        <div class="view-criteria">
          <h4>‚úÖ Success Criteria</h4>
          <p id="view-criteria"></p>
        </div>
      </div>

      <div class="view-section" id="journey-section" style="display:none">
        <div class="view-journey">
          <h4>üó∫Ô∏è User Journey</h4>
          <p id="view-journey"></p>
        </div>
      </div>

      <div class="view-section" id="subtasks-section">
        <div class="subtasks-section">
          <div class="subtasks-header">
            <span class="subtasks-title">üìã Subtasks</span>
            <span class="subtasks-progress" id="subtasks-progress"></span>
          </div>
          <div id="subtasks-list"></div>
          <div class="add-subtask-form">
            <input type="text" class="add-subtask-input" id="add-subtask-input" placeholder="Add a subtask..." onkeypress="if(event.key==='Enter')addSubtask()">
            <button class="add-subtask-btn" onclick="addSubtask()">Add</button>
          </div>
        </div>
      </div>

      <div class="view-section">
        <div class="view-meta" id="view-meta"></div>
      </div>
      
      <div class="view-section" id="changelog-section">
        <details class="changelog-details">
          <summary style="cursor:pointer;color:var(--text-secondary);font-size:0.85rem;padding:8px 0;">üìã View Change Log</summary>
          <div id="task-changelog" style="margin-top:12px;"></div>
        </details>
      </div>

      <div class="view-section" id="celebration-image" style="display:none"></div>

      <div class="comments-section">
        <div class="comments-title">üí¨ Activity Log</div>
        <div id="comments-list"></div>
        <div class="comment-input-container">
          <div style="display:flex;gap:8px;align-items:flex-end;width:100%;">
            <textarea class="comment-input" id="comment-input" placeholder="Add feedback..." rows="1" style="flex:1;"></textarea>
            <input type="file" id="comment-image-input" accept="image/*" style="display:none;" onchange="previewCommentImage(this)">
            <button onclick="document.getElementById('comment-image-input').click()" style="padding:10px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;cursor:pointer;" title="Attach image">üì∑</button>
            <button class="comment-send" onclick="addComment()">Send</button>
          </div>
          <div id="comment-image-preview" style="display:none;margin-top:8px;"></div>
        </div>
      </div>

      <div class="move-actions" id="move-actions"></div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="edit-modal" id="edit-modal">
    <div class="edit-content">
      <div class="edit-header">
        <h2 id="edit-title">New Wish</h2>
        <button class="modal-close" onclick="closeEditModal()">Cancel</button>
      </div>
      
      <div class="edit-body">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="task-title" placeholder="What do you wish for?">
        </div>
        
        <div class="form-group">
          <label>Description <span class="hint">‚Äî What needs to happen</span></label>
          <textarea id="task-desc" class="large" placeholder="Describe what this wish accomplishes..."></textarea>
        </div>

        <div class="form-group">
          <label>üì∑ Image <span class="hint">‚Äî Optional attachment</span></label>
          <input type="file" id="task-image" accept="image/*" onchange="previewImage(this)" style="display:none">
          <div id="image-preview" style="margin-top:8px"></div>
          <button type="button" onclick="document.getElementById('task-image').click()" style="padding:10px 16px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer">üì∑ Add Image</button>
        </div>

        <div class="form-group">
          <label>Success Criteria <span class="hint">‚Äî How do we know it's done?</span></label>
          <textarea id="task-criteria" placeholder="‚Ä¢ Criterion 1&#10;‚Ä¢ Criterion 2&#10;‚Ä¢ Criterion 3"></textarea>
        </div>

        <div class="form-group">
          <label>User Journey <span class="hint">‚Äî Example scenario where this matters</span></label>
          <textarea id="task-journey" placeholder="When [user] wants to [action], they can now [benefit]..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Priority</label>
          <select id="task-priority">
            <option value="high">üî¥ Critical</option>
            <option value="medium">üü° Standard</option>
            <option value="low">üü¢ Low</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Type</label>
          <select id="task-type">
            <option value="single">üìå One-time</option>
            <option value="recurring">üîÑ Recurring</option>
          </select>
        </div>
      </div>
      
      <div class="edit-actions">
        <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button class="btn-delete" id="delete-btn" onclick="deleteTask()">Delete</button>
        <button class="btn-save" onclick="saveTask()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const COLUMNS = {
      genie: { label: 'Genie', icon: 'üßû' },
      inbox: { label: 'Inbox', icon: 'üì•' },
      todo: { label: 'Queued', icon: 'üìã' },
      in_progress: { label: 'Granting', icon: '‚ö°' },
      review: { label: 'Review', icon: 'üëÄ' },
      done: { label: 'Granted', icon: '‚ú®' }
    };
    const COLUMN_ORDER = ['genie', 'inbox', 'todo', 'in_progress', 'review', 'done'];

    let tasks = [];
    let currentColumn = 'inbox';
    let viewingTaskId = null;
    let editingTaskId = null;
    let currentView = 'tasks';
    let typeFilter = 'single';

    function setTypeFilter(filter) {
      typeFilter = filter;
      // Update mobile filter buttons
      document.querySelectorAll(".filter-btn").forEach(b => 
        b.classList.toggle("active", b.dataset.filter === filter)
      );
      // Update desktop filter buttons
      document.querySelectorAll(".desktop-filter-btn").forEach(b => 
        b.classList.toggle("active", b.dataset.filter === filter)
      );
      renderAll();
    }


    document.getElementById('quick-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') quickAdd();
    });

    function getUnreadGenieComments(task) {
      if (!task.comments || task.comments.length === 0) return 0;
      const seenAt = task.seenAt || 0;
      return task.comments.filter(c => c.author === "genie" && new Date(c.time).getTime() > seenAt).length;
    }
    
    // Get total unread count across all tasks
    function getTotalUnreadCount() {
      return tasks.reduce((sum, task) => sum + getUnreadGenieComments(task), 0);
    }
    
    // Update favicon with unread badge
    function updateFaviconBadge(count) {
      const canvas = document.createElement('canvas');
      canvas.width = 64;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');
      
      // Draw lamp emoji
      ctx.font = '48px serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('ü™î', 32, 32);
      
      // Draw badge if count > 0
      if (count > 0) {
        ctx.fillStyle = '#ff453a';
        ctx.beginPath();
        ctx.arc(52, 12, 12, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'white';
        ctx.font = 'bold 14px sans-serif';
        ctx.fillText(count > 9 ? '9+' : count.toString(), 52, 13);
      }
      
      // Update favicon
      let link = document.querySelector("link[rel*='icon']");
      if (!link) {
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      link.href = canvas.toDataURL();
      
      // Also update page title
      document.title = count > 0 ? `(${count}) The Lamp` : 'The Lamp';
    }
    
    // Update nav notification dot
    function updateNavNotification(count) {
      const wishesBtn = document.querySelector('.nav-item[data-view="tasks"]');
      const desktopWishesBtn = document.querySelector('.desktop-nav-btn[data-view="tasks"]');
      
      // Remove existing badges
      document.querySelectorAll('.nav-badge').forEach(b => b.remove());
      
      if (count > 0) {
        const badge = `<span class="nav-badge" style="position:absolute;top:-4px;right:-4px;background:#ff453a;color:white;font-size:10px;padding:2px 5px;border-radius:10px;font-weight:bold;">${count > 9 ? '9+' : count}</span>`;
        if (wishesBtn) {
          wishesBtn.style.position = 'relative';
          wishesBtn.insertAdjacentHTML('beforeend', badge);
        }
        if (desktopWishesBtn) {
          desktopWishesBtn.style.position = 'relative';
          desktopWishesBtn.insertAdjacentHTML('beforeend', badge);
        }
      }
    }
    
    // Call this after rendering
    function updateNotifications() {
      const count = getTotalUnreadCount();
      updateFaviconBadge(count);
      updateNavNotification(count);
    }
    
    // Make URLs clickable in text (XSS-safe)
    function linkify(text) {
      if (!text) return '';
      // Escape HTML first
      const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      // Then convert URLs to links
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener" style="color: var(--accent); word-break: break-all;">$1</a>');
    }


    function smartAdd() {
      const input = document.getElementById("quick-input");
      const title = input.value.trim();
      if (!title) { openNewTask(); } else { quickAdd(); }
    }

    function showWishSparkle() {
      const sparkle = document.createElement("div");
      sparkle.className = "wish-sparkle";
      sparkle.textContent = "‚ú®";
      sparkle.style.left = Math.random() * window.innerWidth + "px";
      sparkle.style.top = "150px";
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 800);
    }

    function showGrantCelebration() {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const sparkle = document.createElement("div");
          sparkle.className = "wish-sparkle";
          sparkle.textContent = ["üéâ", "‚ú®", "üåü", "üí´", "‚≠ê"][i];
          sparkle.style.left = (20 + Math.random() * 60) + "%";
          sparkle.style.top = (30 + Math.random() * 40) + "%";
          document.body.appendChild(sparkle);
          setTimeout(() => sparkle.remove(), 800);
        }, i * 100);
      }
    }


    function quickAdd() {
      const input = document.getElementById('quick-input');
      const title = input.value.trim();
      if (!title) return;

      tasks.push({
        id: Date.now().toString(),
        title,
        description: '',
        successCriteria: '',
        userJourney: '',
        column: 'inbox',
        created: new Date().toISOString().split('T')[0],
        priority: 'medium',
        type: 'single',
        comments: []
      });
      showWishSparkle();

      input.value = '';
      renderAll();
      saveTasks();
    }

    async function loadTasks() {
      updateStatus('syncing', 'SYNCING');
      try {
        const res = await fetch('/api/tasks');
        const data = await res.json();
        tasks = (data.tasks || []).map(t => ({
          ...t,
          comments: t.comments || [],
          successCriteria: t.successCriteria || '',
          userJourney: t.userJourney || ''
        }));
        // Set lastSavedTasks to enable rollback on failed saves
        lastSavedTasks = JSON.parse(JSON.stringify(tasks));
        localStorage.setItem('lamp-tasks', JSON.stringify(tasks));
        renderAll();
        updateStatus('connected', 'ONLINE');
      } catch (e) {
        const saved = localStorage.getItem('lamp-tasks');
        if (saved) {
          tasks = JSON.parse(saved);
          lastSavedTasks = JSON.parse(JSON.stringify(tasks));
        }
        renderAll();
        updateStatus('offline', 'OFFLINE');
      }
    }

    let lastSavedTasks = null; // Track last successful state for rollback
    
    async function saveTasks() {
      updateStatus('syncing', 'SAVING');
      const tasksToSave = JSON.parse(JSON.stringify(tasks)); // Deep copy
      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ columns: COLUMN_ORDER, tasks: tasksToSave })
        });
        const data = await res.json();
        if (data.ok) {
          // Only save to localStorage AFTER server confirms
          localStorage.setItem('lamp-tasks', JSON.stringify(tasks));
          lastSavedTasks = JSON.parse(JSON.stringify(tasks));
          updateStatus('connected', 'SAVED');
          setTimeout(() => updateStatus('connected', 'ONLINE'), 1000);
          return true;
        } else {
          throw new Error('Server returned not ok');
        }
      } catch (e) {
        console.error('Save failed:', e);
        updateStatus('offline', 'SAVE FAILED');
        // Revert to last known good state
        if (lastSavedTasks) {
          tasks = JSON.parse(JSON.stringify(lastSavedTasks));
          renderAll();
          alert('Save failed. Your changes were reverted. Please try again.');
        } else {
          alert('Save failed. Please refresh and try again.');
        }
        return false;
      }
    }

    function updateStatus(state, text) {
      document.getElementById('status-dot').className = 'status-dot' + (state === 'syncing' ? ' syncing' : '');
      document.getElementById('status-text').textContent = text;
    }

    function renderTabs() {
      document.getElementById('tabs').innerHTML = COLUMN_ORDER.map(col => {
        const count = tasks.filter(t => t.column === col).length;
        return `<button class="mission-tab ${col === currentColumn ? 'active' : ''}" onclick="selectColumn('${col}')">
          ${COLUMNS[col].icon} ${COLUMNS[col].label}
          <span class="count">${count}</span>
        </button>`;
      }).join('');
    }

    function renderTasks() {
      const container = document.getElementById('task-container');
      // Genie column ignores type filter - shows all ideas
      // Recurring tasks are excluded - they have their own dedicated page
      let colTasks = tasks.filter(t => {
        if (t.column !== currentColumn) return false;
        if (t.type === 'recurring') return false; // Recurring has its own page
        if (currentColumn === 'genie') return true;
        if (typeFilter === 'laptop') return t.needsLaptop;
        if (typeFilter === 'mobile') return t.needsMobile;
        // Hide laptop-only and mobile-only tasks unless their filter is active
        if (t.needsLaptop && typeFilter !== 'laptop') return false;
        if (t.needsMobile && typeFilter !== 'mobile') return false;
        if (typeFilter === 'all') return true;
        return (t.type || 'single') === typeFilter;
      });
      
      // Sort based on column
      if (currentColumn === 'done') {
        // Granted: newest first (by id which is timestamp, or created date)
        colTasks.sort((a, b) => {
          const aTime = parseInt(a.id) || new Date(a.created).getTime() || 0;
          const bTime = parseInt(b.id) || new Date(b.created).getTime() || 0;
          return bTime - aTime; // descending (newest first)
        });
      } else if (currentColumn === 'review') {
        // Review: oldest updates first (tasks waiting longest get attention)
        colTasks.sort((a, b) => {
          const aLast = a.comments?.length ? new Date(a.comments[a.comments.length-1].time).getTime() : (parseInt(a.id) || new Date(a.created).getTime() || 0);
          const bLast = b.comments?.length ? new Date(b.comments[b.comments.length-1].time).getTime() : (parseInt(b.id) || new Date(b.created).getTime() || 0);
          return aLast - bLast; // ascending (oldest first)
        });
      }

      // Hide type filter for genie column
      document.getElementById('type-filter').style.display = currentColumn === 'genie' ? 'none' : 'flex';

      if (colTasks.length === 0) {
        const emptyMsg = currentColumn === 'genie' 
          ? { title: 'No ideas yet', desc: 'Genie is thinking of new suggestions...' }
          : currentColumn === 'done'
          ? { title: 'All wishes granted!', desc: 'The genie awaits your command' }
          : { title: 'No wishes here', desc: 'The genie awaits your command' };
        container.innerHTML = `<div class="empty-state">
          <div class="icon">${COLUMNS[currentColumn].icon}</div>
          <h3>${emptyMsg.title}</h3>
          <p>${emptyMsg.desc}</p>
        </div>`;
        return;
      }

      container.innerHTML = colTasks.map(task => {
        const commentCount = (task.comments || []).length;
        const badges = task.type === 'recurring' ? '<span class="badge recurring">üîÑ</span>' : '';
        const desc = task.description || 'No description yet ‚Äî tap to add details';
        const isShort = desc.length < 150;
        
        const hasUnread = getUnreadGenieComments(task) > 0;
        return `<div class="task-card priority-${task.priority} ${hasUnread ? 'has-unread' : ''}" onclick="viewTask('${task.id}')">
          <div class="task-card-header">
            <div class="task-title">${task.title}</div>
            <div class="task-badges">${badges}</div>
          </div>
          <div class="task-desc-preview ${isShort ? 'short' : ''}">${desc}</div>
          <div class="task-footer">
            <span>${task.created}</span>
            ${task.needsLaptop ? '<span style="opacity:0.7">üíª</span>' : ''}
            ${task.needsMobile ? '<span style="opacity:0.7">üì±</span>' : ''}
            ${task.image ? '<span style="opacity:0.7">üì∑</span>' : ''}
            ${(() => { const unread = getUnreadGenieComments(task); return unread > 0 ? `<span class="unread-badge">üßû ${unread}</span>` : ""; })()}${commentCount > 0 ? `<span class="comments-count">üí¨ ${commentCount}</span>` : ""}
          </div>
        </div>`;
      }).join('');
    }

    function isDesktop() {
      return window.innerWidth >= 1024;
    }

    function renderKanban() {
      const container = document.getElementById('kanban-container');
      if (!container) return;
      
      // Order: Inbox, To Do, In Progress, Review (skip Genie and Done for main Kanban view, add as last columns)
      const kanbanColumns = ['genie', 'inbox', 'todo', 'in_progress', 'review', 'done'];
      
      container.innerHTML = kanbanColumns.map(col => {
        // Filter out recurring tasks - they have their own dedicated page
        let colTasks = tasks.filter(t => t.column === col && t.type !== 'recurring');
        
        // Apply type filter (except for genie)
        if (col !== 'genie' && typeFilter !== 'all') {
          colTasks = colTasks.filter(t => {
            if (typeFilter === 'laptop') return t.needsLaptop;
            if (typeFilter === 'mobile') return t.needsMobile;
            if (typeFilter === 'recurring') return t.type === 'recurring';
            if (t.needsLaptop) return false;
            if (t.needsMobile) return false;
            return (t.type || 'single') === typeFilter;
          });
        }
        
        // Sort
        if (col === 'done') {
          colTasks.sort((a, b) => (parseInt(b.id) || 0) - (parseInt(a.id) || 0));
        } else if (col === 'review') {
          colTasks.sort((a, b) => {
            const aLast = a.comments?.length ? new Date(a.comments[a.comments.length-1].time).getTime() : parseInt(a.id) || 0;
            const bLast = b.comments?.length ? new Date(b.comments[b.comments.length-1].time).getTime() : parseInt(b.id) || 0;
            return aLast - bLast;
          });
        }
        
        const tasksHTML = colTasks.length > 0 
          ? colTasks.map(task => {
              const desc = (task.description || '').slice(0, 100);
              const commentCount = (task.comments || []).length;
              const unread = getUnreadGenieComments(task);
              
              return `<div class="kanban-card priority-${task.priority} ${unread > 0 ? 'has-unread' : ''}" draggable="true" data-task-id="${task.id}" onclick="viewTask('${task.id}')" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                <div class="kanban-card-title">${task.title}</div>
                ${desc ? `<div class="kanban-card-desc">${desc}${task.description?.length > 100 ? '...' : ''}</div>` : ''}
                <div class="kanban-card-footer">
                  <span>${task.created}</span>
                  <div class="kanban-card-meta">
                    ${task.type === 'recurring' ? '<span>üîÑ</span>' : ''}
                    ${task.needsLaptop ? '<span>üíª</span>' : ''}
                    ${task.needsMobile ? '<span>üì±</span>' : ''}
                    ${task.image ? '<span>üì∑</span>' : ''}
                    ${unread > 0 ? `<span class="unread-badge">üßû ${unread}</span>` : ''}
                    ${commentCount > 0 ? `<span style="color:var(--info)">üí¨ ${commentCount}</span>` : ''}
                  </div>
                </div>
              </div>`;
            }).join('')
          : `<div class="kanban-empty">
              <div class="icon">${COLUMNS[col].icon}</div>
              <p>${col === 'done' ? 'No granted wishes yet' : 'No wishes here'}</p>
            </div>`;
        
        return `<div class="kanban-column" data-column="${col}">
          <div class="kanban-column-header">
            <div class="kanban-column-title">
              <span class="icon">${COLUMNS[col].icon}</span>
              ${COLUMNS[col].label}
            </div>
            <span class="kanban-column-count">${colTasks.length}</span>
          </div>
          <div class="kanban-column-tasks" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${col}')">${tasksHTML}</div>
        </div>`;
      }).join('');
    }

    function renderAll() {
      const desktop = isDesktop();
      
      // On desktop, hide kanban for non-task views
      const kanbanEl = document.getElementById('kanban-container');
      const taskEl = document.getElementById('task-container');
      
      if (desktop) {
        if (currentView === 'tasks') {
          kanbanEl.style.display = 'flex';
          taskEl.style.display = 'none';
          renderKanban();
        } else {
          kanbanEl.style.display = 'none';
          taskEl.style.display = 'block';
          if (currentView === 'stats') renderStats();
          else if (currentView === 'history') renderHistory();
          else if (currentView === 'recurring') renderRecurring();
          else if (currentView === 'console') renderConsole();
        }
      } else {
        // Mobile: always use task container
        kanbanEl.style.display = 'none';
        taskEl.style.display = 'block';
        renderTabs();
        if (currentView === 'tasks') renderTasks();
        else if (currentView === 'stats') renderStats();
        else if (currentView === 'history') renderHistory();
        else if (currentView === 'recurring') renderRecurring();
        else if (currentView === 'console') renderConsole();
      }
      
      // Update notification badges
      updateNotifications();
    }

    function selectColumn(col) {
      currentColumn = col;
      currentView = 'tasks';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === 'tasks'));
      renderAll();
    }

    function viewTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      viewingTaskId = id;
      task.seenAt = Date.now();
      renderAll(); // Update task cards immediately to clear unread badge
      saveTasks();
      document.getElementById('view-title').textContent = task.title;
      document.getElementById('view-desc').innerHTML = linkify(task.description) || 'No description provided';
      
      // Success Criteria
      const criteriaSection = document.getElementById('criteria-section');
      if (task.successCriteria) {
        document.getElementById('view-criteria').innerHTML = linkify(task.successCriteria);
        criteriaSection.style.display = 'block';
      } else {
        criteriaSection.style.display = 'none';
      }

      // User Journey
      const journeySection = document.getElementById('journey-section');
      if (task.userJourney) {
        document.getElementById('view-journey').innerHTML = linkify(task.userJourney);
        journeySection.style.display = 'block';
      } else {
        journeySection.style.display = 'none';
      }
      
      // Subtasks
      renderSubtasks(task);
      
      // Meta
      const pIcon = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üü¢';
      document.getElementById('view-meta').innerHTML = `
        <div class="meta-item">üìÖ ${task.created}</div>
        <div class="meta-item">${pIcon} ${task.priority}</div>
        <div class="meta-item">${task.type === 'recurring' ? 'üîÑ Recurring' : 'üìå One-time'}</div>
        <div class="meta-item">${COLUMNS[task.column].icon} ${COLUMNS[task.column].label}</div>
      `;

      // Task image or Celebration image
      const imageDiv = document.getElementById('celebration-image');
      if (task.image) {
        imageDiv.innerHTML = `<img src="${task.image}" alt="Attached" style="width:100%;border-radius:12px;margin:12px 0;">`;
        imageDiv.style.display = 'block';
      } else if (task.celebrationImage && task.column === 'done') {
        imageDiv.innerHTML = `<img src="${task.celebrationImage}" alt="Celebration" style="width:100%;border-radius:12px;margin:12px 0;">`;
        imageDiv.style.display = 'block';
      } else {
        imageDiv.style.display = 'none';
      }

      // Comments
      const comments = task.comments || [];
      if (comments.length === 0) {
        document.getElementById('comments-list').innerHTML = '<div class="no-comments">No activity yet</div>';
      } else {
        document.getElementById('comments-list').innerHTML = comments.map(c => `
          <div class="comment">
            <div class="comment-header">
              <span class="comment-author ${c.author}">${c.author === 'genie' ? 'üßû Genie' : 'üë§ Michael'}</span>
              <span class="comment-time">${c.time}</span>
            </div>
            ${c.text ? `<div class="comment-text">${linkify(c.text)}</div>` : ''}
            ${c.image ? `<div class="comment-image"><img src="${c.image}" style="max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer;" onclick="window.open('${c.image}', '_blank')"></div>` : ''}
          </div>
        `).join('');
      }

      // Move buttons - special handling for genie column
      const colIdx = COLUMN_ORDER.indexOf(task.column);
      const canLeft = colIdx > 0 && task.column !== 'inbox'; // Can't go left from inbox (genie is special)
      const canRight = colIdx < COLUMN_ORDER.length - 1;
      
      if (task.column === 'genie') {
        // Genie suggestions: Approve or Discard
        document.getElementById('move-actions').innerHTML = `
          <button class="move-btn" onclick="discardIdea('${id}')">‚ùå Discard</button>
          <button class="move-btn primary" onclick="approveIdea('${id}')">‚úÖ Approve</button>
        `;
      } else if (task.column === 'review') {
        // Review tasks: option to mark for laptop or mobile review
        const laptopBtn = task.needsLaptop 
          ? `<button class="move-btn" onclick="toggleLaptop('${id}')" style="background:var(--info)">üíª On Laptop</button>`
          : `<button class="move-btn" onclick="toggleLaptop('${id}')">üíª Laptop</button>`;
        const mobileBtn = task.needsMobile 
          ? `<button class="move-btn" onclick="toggleMobile('${id}')" style="background:var(--purple)">üì± On Mobile</button>`
          : `<button class="move-btn" onclick="toggleMobile('${id}')">üì± Mobile</button>`;
        document.getElementById('move-actions').innerHTML = `
          ${canLeft ? `<button class="move-btn" onclick="moveTask('${id}', -1)">‚Üê ${COLUMNS[COLUMN_ORDER[colIdx - 1]].label}</button>` : ''}
          ${laptopBtn}
          ${mobileBtn}
          ${canRight ? `<button class="move-btn primary" onclick="moveTask('${id}', 1)">${COLUMNS[COLUMN_ORDER[colIdx + 1]].label} ‚Üí</button>` : ''}
        `;
      } else {
        document.getElementById('move-actions').innerHTML = `
          ${canLeft ? `<button class="move-btn" onclick="moveTask('${id}', -1)">‚Üê ${COLUMNS[COLUMN_ORDER[colIdx - 1]].label}</button>` : ''}
          ${canRight ? `<button class="move-btn primary" onclick="moveTask('${id}', 1)">${COLUMNS[COLUMN_ORDER[colIdx + 1]].label} ‚Üí</button>` : ''}
        `;
      }

      // Load changelog for this task
      loadTaskChangelog(id);

      document.getElementById('view-modal').classList.add('active');
    }
    
    async function loadTaskChangelog(taskId) {
      const changelogDiv = document.getElementById('task-changelog');
      changelogDiv.innerHTML = '<span style="color:var(--text-tertiary);font-size:0.8rem;">Loading...</span>';
      
      try {
        const res = await fetch('/api/history?limit=50');
        const history = await res.json();
        
        // Filter history for this task
        const taskHistory = history.filter(h => h.taskId === taskId || h.taskTitle === tasks.find(t => t.id === taskId)?.title);
        
        if (taskHistory.length === 0) {
          changelogDiv.innerHTML = '<span style="color:var(--text-tertiary);font-size:0.8rem;">No changes recorded yet</span>';
          return;
        }
        
        changelogDiv.innerHTML = taskHistory.map(h => {
          const time = new Date(h.time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const icon = h.type === 'add' ? '‚ú®' : h.type === 'move' ? '‚Üí' : h.type === 'comment' ? 'üí¨' : '‚Ä¢';
          const authorIcon = h.author === 'genie' ? 'üßû' : 'üë§';
          let desc = '';
          if (h.type === 'add') desc = 'Created';
          else if (h.type === 'move') desc = `Moved ${h.from} ‚Üí ${h.to}`;
          else if (h.type === 'comment') desc = 'Commented';
          
          return `<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:0.8rem;">
            <span>${icon}</span> ${desc} <span style="color:var(--text-tertiary)">‚Ä¢ ${authorIcon} ${h.author} ‚Ä¢ ${time}</span>
          </div>`;
        }).join('');
      } catch (e) {
        changelogDiv.innerHTML = '<span style="color:var(--text-tertiary);font-size:0.8rem;">Could not load changelog</span>';
      }
    }

    function renderSubtasks(task) {
      const list = document.getElementById('subtasks-list');
      const progress = document.getElementById('subtasks-progress');
      const subtasks = task.subtasks || [];
      
      if (subtasks.length === 0) {
        list.innerHTML = '<div style="color:var(--text-tertiary);font-size:0.85rem;padding:8px 0;">No subtasks yet</div>';
        progress.textContent = '';
      } else {
        const completed = subtasks.filter(s => s.done).length;
        progress.textContent = `${completed}/${subtasks.length} done`;
        list.innerHTML = subtasks.map((s, i) => `
          <div class="subtask-item">
            <input type="checkbox" class="subtask-checkbox" ${s.done ? 'checked' : ''} onchange="toggleSubtask(${i})">
            <span class="subtask-text ${s.done ? 'completed' : ''}">${escapeHtml(s.text)}</span>
            <button class="subtask-delete" onclick="deleteSubtask(${i})">‚úï</button>
          </div>
        `).join('');
      }
    }

    async function addSubtask() {
      const input = document.getElementById('add-subtask-input');
      const text = input.value.trim();
      if (!text || !viewingTaskId) return;

      const task = tasks.find(t => t.id === viewingTaskId);
      if (!task) return;

      if (!task.subtasks) task.subtasks = [];
      task.subtasks.push({ text, done: false });
      input.value = '';
      renderSubtasks(task);
      await saveTasks();
    }

    async function toggleSubtask(index) {
      const task = tasks.find(t => t.id === viewingTaskId);
      if (!task || !task.subtasks || !task.subtasks[index]) return;

      task.subtasks[index].done = !task.subtasks[index].done;
      renderSubtasks(task);
      await saveTasks();
    }

    async function deleteSubtask(index) {
      const task = tasks.find(t => t.id === viewingTaskId);
      if (!task || !task.subtasks) return;

      task.subtasks.splice(index, 1);
      renderSubtasks(task);
      await saveTasks();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function closeViewModal() {
      document.getElementById('view-modal').classList.remove('active');
      viewingTaskId = null;
    }

    let commentImageData = null;
    
    function previewCommentImage(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        commentImageData = e.target.result;
        const preview = document.getElementById('comment-image-preview');
        preview.innerHTML = `
          <div style="position:relative;display:inline-block;">
            <img src="${commentImageData}" style="max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--border);">
            <button onclick="clearCommentImage()" style="position:absolute;top:-8px;right:-8px;background:var(--danger);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;">√ó</button>
          </div>
        `;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
    
    function clearCommentImage() {
      commentImageData = null;
      document.getElementById('comment-image-input').value = '';
      document.getElementById('comment-image-preview').style.display = 'none';
      document.getElementById('comment-image-preview').innerHTML = '';
    }

    async function addComment() {
      const input = document.getElementById('comment-input');
      const sendBtn = document.querySelector('.comment-send');
      const text = input.value.trim();
      if (!text && !commentImageData) return;
      if (!viewingTaskId) return;

      const task = tasks.find(t => t.id === viewingTaskId);
      if (!task) return;

      // Show loading state
      const originalBtnText = sendBtn.textContent;
      sendBtn.textContent = '...';
      sendBtn.disabled = true;
      sendBtn.style.opacity = '0.5';

      if (!task.comments) task.comments = [];
      const comment = {
        author: 'michael',
        text: text || '',
        time: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
      };
      
      if (commentImageData) {
        comment.image = commentImageData;
      }
      
      task.comments.push(comment);
      input.value = '';
      clearCommentImage();

      try {
        await saveTasks();
        // Show success feedback
        sendBtn.textContent = '‚úì';
        sendBtn.style.background = 'var(--success)';
        setTimeout(() => {
          sendBtn.textContent = originalBtnText;
          sendBtn.disabled = false;
          sendBtn.style.opacity = '1';
          sendBtn.style.background = '';
        }, 1000);
      } catch (e) {
        // Show error feedback
        sendBtn.textContent = '‚úó';
        sendBtn.style.background = 'var(--danger)';
        setTimeout(() => {
          sendBtn.textContent = originalBtnText;
          sendBtn.disabled = false;
          sendBtn.style.opacity = '1';
          sendBtn.style.background = '';
        }, 2000);
      }
      
      viewTask(viewingTaskId);
    }

    function moveTask(id, direction) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      const idx = COLUMN_ORDER.indexOf(task.column);
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= COLUMN_ORDER.length) return;
      
      // Skip genie column when moving normally
      const targetCol = COLUMN_ORDER[newIdx];
      if (targetCol === 'genie') return;
      
      task.column = targetCol;
      
      if (targetCol === "done") {
        showGrantCelebration();
        setTimeout(closeViewModal, 600);
        // Generate celebration image
        generateCelebrationImage(task);
      }
      
      if (viewingTaskId === id) viewTask(id);
      renderAll();
      saveTasks();
    }

    async function generateCelebrationImage(task) {
      try {
        const res = await fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ taskTitle: task.title })
        });
        const data = await res.json();
        if (data.ok && data.imageUrl) {
          task.celebrationImage = data.imageUrl;
          saveTasks();
          renderAll();
        }
      } catch (e) {
        console.log('Image generation failed:', e);
      }
    }

    function approveIdea(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.column = 'inbox';
      closeViewModal();
      renderAll();
      saveTasks();
    }

    function discardIdea(id) {
      if (!confirm('Discard this idea?')) return;
      tasks = tasks.filter(t => t.id !== id);
      closeViewModal();
      renderAll();
      saveTasks();
    }

    function toggleLaptop(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.needsLaptop = !task.needsLaptop;
      viewTask(id); // Refresh the view
      renderAll();
      saveTasks();
    }

    function toggleMobile(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.needsMobile = !task.needsMobile;
      viewTask(id); // Refresh the view
      renderAll();
      saveTasks();
    }

    function editCurrentTask() {
      if (!viewingTaskId) return;
      closeViewModal();
      openEditModal(viewingTaskId);
    }

    function openNewTask() {
      editingTaskId = null;
      document.getElementById('edit-title').textContent = 'New Wish';
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
      document.getElementById('task-criteria').value = '';
      document.getElementById('task-journey').value = '';
      document.getElementById('task-priority').value = 'medium';
      document.getElementById('task-type').value = 'single';
      document.getElementById('delete-btn').style.display = 'none';
      document.getElementById('edit-modal').classList.add('active');
    }

    function openLampFeedback() {
      editingTaskId = null;
      document.getElementById('edit-title').textContent = 'üêõ Lamp Feedback';
      document.getElementById('task-title').value = '';
      document.getElementById('task-title').placeholder = 'Describe the issue or feature...';
      document.getElementById('task-desc').value = '[LAMP] Feature or bug for The Lamp dashboard:\n\n';
      document.getElementById('task-criteria').value = '';
      document.getElementById('task-journey').value = '';
      document.getElementById('task-priority').value = 'medium';
      document.getElementById('task-type').value = 'single';
      document.getElementById('delete-btn').style.display = 'none';
      document.getElementById('edit-modal').classList.add('active');
    }

    function openEditModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;

      editingTaskId = id;
      document.getElementById('edit-title').textContent = 'Edit Wish';
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-desc').value = task.description || '';
      document.getElementById('task-criteria').value = task.successCriteria || '';
      document.getElementById('task-journey').value = task.userJourney || '';
      document.getElementById('task-priority').value = task.priority;
      document.getElementById('task-type').value = task.type || 'single';
      document.getElementById('delete-btn').style.display = 'block';
      
      // Load existing image if any
      if (task.image) {
        currentTaskImage = task.image;
        document.getElementById('image-preview').innerHTML = `<img src="${task.image}" style="max-width:100%;max-height:150px;border-radius:8px;margin-bottom:8px"><br><button type="button" onclick="clearImage()" style="padding:6px 12px;background:var(--danger);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer">Remove</button>`;
      } else {
        clearImage();
      }
      
      document.getElementById('edit-modal').classList.add('active');
    }

    let currentTaskImage = null;

    function previewImage(input) {
      const preview = document.getElementById('image-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentTaskImage = e.target.result;
          preview.innerHTML = `<img src="${currentTaskImage}" style="max-width:100%;max-height:150px;border-radius:8px;margin-bottom:8px"><br><button type="button" onclick="clearImage()" style="padding:6px 12px;background:var(--danger);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer">Remove</button>`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function clearImage() {
      currentTaskImage = null;
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('task-image').value = '';
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      editingTaskId = null;
      clearImage();
    }

    function saveTask() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) return;

      const data = {
        title,
        description: document.getElementById('task-desc').value.trim(),
        successCriteria: document.getElementById('task-criteria').value.trim(),
        userJourney: document.getElementById('task-journey').value.trim(),
        priority: document.getElementById('task-priority').value,
        type: document.getElementById('task-type').value,
        image: currentTaskImage || undefined
      };

      if (editingTaskId) {
        const task = tasks.find(t => t.id === editingTaskId);
        if (task) Object.assign(task, data);
      } else {
        tasks.push({
          id: Date.now().toString(),
          ...data,
          column: 'inbox',
          created: new Date().toISOString().split('T')[0],
          comments: []
        });
      showWishSparkle();
      }

      closeEditModal();
      renderAll();
      saveTasks();
    }

    function deleteTask() {
      if (!editingTaskId || !confirm('Delete this wish?')) return;
      tasks = tasks.filter(t => t.id !== editingTaskId);
      closeEditModal();
      renderAll();
      saveTasks();
    }

    function switchView(view) {
      console.log('Switching to view:', view);
      currentView = view;
      // Update mobile nav
      document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === view));
      // Update desktop nav
      document.querySelectorAll('.desktop-nav-btn').forEach(n => n.classList.toggle('active', n.dataset.view === view));
      // Force scroll to top when switching views
      window.scrollTo(0, 0);
      const container = document.getElementById('task-container');
      if (container) container.scrollTop = 0;
      renderAll();
    }

    let historyFilter = 'all';
    async function renderHistory() {
      const container = document.getElementById('task-container');
      container.innerHTML = '<h2 style="margin:0 0 16px;color:var(--accent);">üìú Activity History</h2><div style="padding:20px;text-align:center;color:var(--text-secondary)">Loading...</div>';
      
      try {
        const res = await fetch('/api/history?author=' + historyFilter);
        const history = await res.json();
        
        const filterHtml = `
          <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
            <button class="filter-btn ${historyFilter === 'all' ? 'active' : ''}" onclick="setHistoryFilter('all')">All</button>
            <button class="filter-btn ${historyFilter === 'michael' ? 'active' : ''}" onclick="setHistoryFilter('michael')">Michael</button>
            <button class="filter-btn ${historyFilter === 'genie' ? 'active' : ''}" onclick="setHistoryFilter('genie')">Genie</button>
          </div>
        `;
        
        if (history.length === 0) {
          container.innerHTML = filterHtml + '<div style="padding:40px;text-align:center;color:var(--text-secondary)">No history yet</div>';
          return;
        }
        
        const items = history.map(h => {
          const time = new Date(h.time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const icon = h.type === 'add' ? '‚ú®' : h.type === 'move' ? '‚Üí' : h.type === 'comment' ? 'üí¨' : h.type === 'delete' ? 'üóëÔ∏è' : '‚Ä¢';
          const authorIcon = h.author === 'genie' ? 'üßû' : h.author === 'michael' ? 'üë§' : '';
          let desc = '';
          if (h.type === 'add') desc = 'Created: ' + h.taskTitle;
          else if (h.type === 'move') desc = 'Moved "' + h.taskTitle + '" ' + h.from + ' ‚Üí ' + h.to;
          else if (h.type === 'comment') desc = 'Commented on "' + h.taskTitle + '": ' + (h.commentText || '');
          else if (h.type === 'delete') desc = 'Deleted: ' + h.taskTitle;
          
          return '<div style="padding:12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start;">' +
            '<span style="font-size:1.4rem;">' + authorIcon + '</span>' +
            '<div style="flex:1;">' +
              '<div style="color:var(--text-primary);font-size:0.9rem;">' + icon + ' ' + desc + '</div>' +
              '<div style="color:var(--text-tertiary);font-size:0.75rem;margin-top:4px;">' + time + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
        
        container.innerHTML = filterHtml + '<div style="background:var(--bg-secondary);border-radius:var(--radius-lg);overflow:hidden;">' + items + '</div>';
      } catch (e) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--error)">Error loading history</div>';
      }
    }
    
    // Drag and Drop for Kanban
    let draggedTaskId = null;
    
    function handleDragStart(e) {
      draggedTaskId = e.target.dataset.taskId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedTaskId);
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.kanban-column-tasks').forEach(el => el.classList.remove('drag-over'));
      draggedTaskId = null;
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    
    async function handleDrop(e, targetColumn) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const taskId = e.dataTransfer.getData('text/plain') || draggedTaskId;
      if (!taskId) return;
      
      const task = tasks.find(t => t.id === taskId);
      if (!task || task.column === targetColumn) return;
      
      // Update locally
      const oldColumn = task.column;
      task.column = targetColumn;
      renderKanban();
      
      // Save to server
      try {
        await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'update', taskId, updates: { column: targetColumn } })
        });
        updateStatus('online', 'SYNCED');
      } catch (err) {
        // Revert on error
        task.column = oldColumn;
        renderKanban();
        updateStatus('error', 'SYNC FAILED');
      }
    }
    
    function setHistoryFilter(f) {
      historyFilter = f;
      renderHistory();
    }

    function renderRecurring() {
      const container = document.getElementById('task-container');
      const recurringTasks = tasks.filter(t => t.type === 'recurring');
      
      let html = `
        <h2 style="margin:0 0 20px;color:var(--accent);display:flex;align-items:center;gap:10px;">
          üîÑ Recurring Tasks
          <span style="font-size:0.7em;color:var(--text-secondary);font-weight:normal;">(${recurringTasks.length} tasks)</span>
        </h2>
      `;
      
      if (recurringTasks.length === 0) {
        html += `
          <div style="padding:40px 20px;text-align:center;color:var(--text-tertiary);">
            <div style="font-size:3rem;margin-bottom:16px;">üîÑ</div>
            <p>No recurring tasks yet</p>
            <p style="font-size:0.85rem;margin-top:8px;">Create a task with type "Recurring" to see it here</p>
          </div>
        `;
      } else {
        html += '<div style="display:grid;gap:12px;">';
        
        recurringTasks.forEach(task => {
          const statusColor = {
            'genie': 'var(--purple)',
            'inbox': 'var(--info)',
            'todo': 'var(--warning)',
            'in_progress': 'var(--accent)',
            'review': 'var(--success)',
            'done': 'var(--text-tertiary)'
          }[task.column] || 'var(--text-secondary)';
          
          const statusLabel = {
            'genie': 'üí° Idea',
            'inbox': 'üì• Inbox',
            'todo': 'üìã To Do',
            'in_progress': 'üî® In Progress',
            'review': 'üëÄ Review',
            'done': '‚úÖ Done'
          }[task.column] || task.column;
          
          html += `
            <div class="task-card" onclick="viewTask('${task.id}')" style="cursor:pointer;padding:16px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border);">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
                <div style="flex:1;">
                  <div style="font-weight:600;margin-bottom:6px;">${task.title}</div>
                  <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.5;">${task.description ? task.description.substring(0, 150) + (task.description.length > 150 ? '...' : '') : 'No description'}</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                  <span style="font-size:0.75rem;padding:4px 8px;border-radius:var(--radius-sm);background:${statusColor}20;color:${statusColor};">${statusLabel}</span>
                  ${task.priority ? `<span style="font-size:0.7rem;color:var(--text-tertiary);">Priority: ${task.priority}</span>` : ''}
                </div>
              </div>
              ${task.comments && task.comments.length > 0 ? `
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:0.8rem;color:var(--text-tertiary);">
                  üí¨ ${task.comments.length} comment${task.comments.length !== 1 ? 's' : ''}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    // Console polling state
    let consolePollInterval = null;
    
    async function renderConsole() {
      const container = document.getElementById('task-container');
      container.innerHTML = `
        <h2 style="margin:0 0 16px;color:var(--accent);">üñ•Ô∏è Genie Console</h2>
        <div style="padding:20px;text-align:center;color:var(--text-secondary)">
          <div class="console-status">Connecting...</div>
        </div>
      `;
      
      // Start polling
      if (consolePollInterval) clearInterval(consolePollInterval);
      pollConsole();
      consolePollInterval = setInterval(pollConsole, 3000);
    }
    
    async function pollConsole() {
      if (currentView !== 'console') {
        if (consolePollInterval) {
          clearInterval(consolePollInterval);
          consolePollInterval = null;
        }
        return;
      }
      
      try {
        const res = await fetch('/api/console');
        const status = await res.json();
        renderConsoleStatus(status);
      } catch (e) {
        renderConsoleStatus({ active: false, error: e.message });
      }
    }
    
    function renderConsoleStatus(status) {
      const container = document.getElementById('task-container');
      const updatedAt = status.updatedAt ? new Date(status.updatedAt).toLocaleString() : 'Never';
      const isStale = status.updatedAt && (Date.now() - new Date(status.updatedAt).getTime() > 60000);
      
      let sessionsHtml = '';
      if (status.sessions && status.sessions.length > 0) {
        sessionsHtml = status.sessions.map(s => `
          <div style="background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;border-left:3px solid ${s.active ? 'var(--success)' : 'var(--text-tertiary)'};">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong style="color:var(--text-primary);">${s.label || s.sessionKey || 'Unknown'}</strong>
              <span style="font-size:0.75rem;padding:4px 8px;border-radius:12px;background:${s.active ? 'var(--success)' : 'var(--text-tertiary)'};color:black;">
                ${s.active ? '‚óè Active' : '‚óã Idle'}
              </span>
            </div>
            ${s.currentTask ? `<div style="color:var(--text-secondary);font-size:0.9rem;">üìã ${s.currentTask}</div>` : ''}
            ${s.model ? `<div style="color:var(--text-tertiary);font-size:0.8rem;margin-top:4px;">Model: ${s.model}</div>` : ''}
          </div>
        `).join('');
      } else {
        sessionsHtml = '<div style="color:var(--text-tertiary);text-align:center;padding:20px;">No active sessions</div>';
      }
      
      container.innerHTML = `
        <h2 style="margin:0 0 16px;color:var(--accent);">üñ•Ô∏è Genie Console</h2>
        
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
          <div style="width:12px;height:12px;border-radius:50%;background:${status.active ? 'var(--success)' : isStale ? 'var(--warning)' : 'var(--text-tertiary)'};animation:${status.active ? 'pulse 2s infinite' : 'none'};"></div>
          <div>
            <div style="color:var(--text-primary);font-weight:600;">
              ${status.active ? 'Genie is Working' : isStale ? 'Status Stale' : 'Genie is Idle'}
            </div>
            <div style="color:var(--text-tertiary);font-size:0.8rem;">Last update: ${updatedAt}</div>
          </div>
        </div>
        
        ${status.currentTask ? `
          <div style="background:var(--accent-dim);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;border:1px solid var(--accent);">
            <div style="color:var(--accent);font-size:0.8rem;margin-bottom:4px;">Currently Working On</div>
            <div style="color:var(--text-primary);font-weight:500;">${status.currentTask}</div>
          </div>
        ` : ''}
        
        <h3 style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;">Sessions</h3>
        ${sessionsHtml}
        
        ${status.error ? `<div style="color:var(--danger);margin-top:12px;">Error: ${status.error}</div>` : ''}
        
        <style>
          @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
          }
        </style>
      `;
    }

    function renderStats() {
      const counts = COLUMN_ORDER.reduce((acc, col) => {
        acc[col] = tasks.filter(t => t.column === col).length;
        return acc;
      }, {});

      document.getElementById('task-container').innerHTML = `<div class="stats-grid">
        <div class="stat-card"><h4>Granting</h4><div class="value accent">${counts.in_progress}</div></div>
        <div class="stat-card"><h4>Review</h4><div class="value">${counts.review}</div></div>
        <div class="stat-card"><h4>Granted</h4><div class="value success">${counts.done}</div></div>
        <div class="stat-card"><h4>Total</h4><div class="value">${tasks.length}</div></div>
      </div>`;
    }

    document.getElementById('comment-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addComment(); }
    });
    
    // Scroll comment input into view when focused (for mobile keyboard)
    document.getElementById('comment-input').addEventListener('focus', () => {
      setTimeout(() => document.getElementById('comment-input').scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
    });

    // Voice recording for wishes
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    async function toggleVoiceRecording() {
      const btn = document.getElementById('voice-btn');
      
      if (isRecording) {
        // Stop recording
        mediaRecorder.stop();
        btn.textContent = 'üé§';
        btn.style.background = '';
        isRecording = false;
      } else {
        // Start recording
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          
          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
          mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop());
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await transcribeAudio(audioBlob);
          };
          
          mediaRecorder.start();
          btn.textContent = '‚èπÔ∏è';
          btn.style.background = 'var(--danger)';
          isRecording = true;
        } catch (err) {
          alert('Microphone access denied. Please allow microphone access to use voice wishes.');
        }
      }
    }

    async function transcribeAudio(blob) {
      const btn = document.getElementById('voice-btn');
      btn.textContent = '‚è≥';
      
      try {
        // Convert blob to base64
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
          const base64 = reader.result.split(',')[1];
          
          const res = await fetch('/api/transcribe', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ audio: base64 })
          });
          const data = await res.json();
          
          if (data.text) {
            btn.textContent = 'üé§';
            // If long text, open modal to show full transcription
            if (data.text.length > 80) {
              openNewTask();
              setTimeout(() => {
                document.getElementById('edit-title-input').value = '';
                document.getElementById('edit-desc').value = data.text;
                document.getElementById('edit-desc').style.minHeight = '200px';
              }, 100);
            } else {
              document.getElementById('quick-input').value = data.text;
            }
          } else {
            alert(data.error || 'Could not transcribe audio.');
            btn.textContent = 'üé§';
          }
        };
      } catch (err) {
        alert('Transcription failed: ' + err.message);
        btn.textContent = 'üé§';
      }
    }

    // Keyboard shortcuts (desktop)
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      switch(e.key) {
        case 'n': openNewTask(); break;
        case 'h': switchView('history'); break;
        case 's': switchView('stats'); break;
        case 't': switchView('tasks'); break;
        case 'Escape': closeViewModal(); closeEditModal(); break;
        case '1': selectColumn('inbox'); break;
        case '2': selectColumn('in_progress'); break;
        case '3': selectColumn('review'); break;
        case '4': selectColumn('done'); break;
        case '5': selectColumn('genie'); break;
      }
    });

    // Handle window resize for responsive view switching
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (currentView === 'tasks') renderAll();
      }, 150);
    });

    loadTasks();
    
    // Real-time updates via Server-Sent Events
    let eventSource = null;
    function connectSSE() {
      if (eventSource) eventSource.close();
      eventSource = new EventSource('/api/events');
      
      eventSource.onopen = () => console.log('[SSE] Connected');
      
      eventSource.addEventListener('tasks', (e) => {
        console.log('[SSE] Task update received');
        loadTasks(); // Refresh on any task change
      });
      
      eventSource.addEventListener('comments', (e) => {
        console.log('[SSE] Comment update received');
        loadTasks(); // Refresh on any comment change
      });
      
      eventSource.addEventListener('genie', (e) => {
        console.log('[SSE] Genie status update');
        if (currentView === 'console') pollConsole();
      });
      
      eventSource.onerror = () => {
        console.log('[SSE] Connection lost, reconnecting in 5s...');
        setTimeout(connectSSE, 5000);
      };
    }
    connectSSE();
    
    // Fallback polling every 30s (reduced from constant)
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
